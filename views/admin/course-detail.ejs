<%- include('./partials/admin-header', { pageCSS: 'courses' }) %>

<!-- Admin Layout -->
<div class="admin-layout">
  <%- include('./partials/admin-sidebar', { currentPage: 'courses' }) %>
  <main class="admin-main">
    <%- include('./partials/admin-topbar', { 
      breadcrumb: `Courses / ${course.title} / Details`,
      breadcrumbSubtitle: 'Enrollments, Topics analytics, and quiz performance',
      showSearch: false
    }) %>

    <div class="admin-content">
      <div class="admin-dashboard admin-fade-in">
        <style>
          /* Professional table styling */
          .table-pro {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
          }

          .table-pro thead th {
            position: sticky;
            top: 0;
            z-index: 2;
            background: linear-gradient(135deg, rgba(184, 1, 1, 0.06) 0%, rgba(184, 1, 1, 0.12) 100%);
            color: var(--admin-text-light);
            padding: 14px 16px;
            font-weight: 700;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--admin-border-light);
            white-space: nowrap;
          }

          .dark-theme .table-pro thead th {
            color: var(--admin-text-dark);
            border-bottom-color: var(--admin-border-dark);
          }

          .table-pro tbody td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--admin-border-light);
            vertical-align: middle;
            font-size: 0.92rem;
          }

          .dark-theme .table-pro tbody td {
            border-bottom-color: var(--admin-border-dark);
          }

          .table-pro tbody tr:hover {
            background: rgba(184, 1, 1, 0.03);
          }

          .dark-theme .table-pro tbody tr:hover {
            background: rgba(184, 1, 1, 0.06);
          }

          .table-pro .col-min {
            width: 1%;
            white-space: nowrap;
          }

          .card-soft {
            background: var(--admin-card-light);
            border: 1px solid var(--admin-border-light);
            border-radius: 12px;
            box-shadow: var(--admin-shadow);
          }

          .dark-theme .card-soft {
            background: var(--admin-card-dark);
            border-color: var(--admin-border-dark);
          }

          .accordion-pro .accordion-item {
            border: none;
            margin-bottom: 12px;
          }

          .accordion-pro .accordion-button {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.0) 0%, rgba(0, 0, 0, 0.02) 100%);
            font-weight: 600;
            padding: 14px 18px;
            border-radius: 10px !important;
            border: 1px solid var(--admin-border-light);
          }

          .dark-theme .accordion-pro .accordion-button {
            border-color: var(--admin-border-dark);
          }

          .accordion-pro .accordion-button:focus {
            box-shadow: none;
          }

          .accordion-pro .accordion-body {
            padding: 0;
          }

          .topic-meta {
            display: flex;
            gap: 14px;
            align-items: center;
            font-size: 0.9rem;
            opacity: 0.85;
          }

          .badge-soft {
            background: rgba(0, 0, 0, 0.06);
            color: inherit;
            border-radius: 6px;
            padding: 6px 10px;
          }

          .dark-theme .badge-soft {
            background: rgba(255, 255, 255, 0.06);
          }
        </style>
        <!-- Header Card -->
        <div class="admin-dashboard-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h1 class="admin-dashboard-title">Course Details - <%= course.title %></h1>
              <p class="admin-dashboard-subtitle">
                <i class="fas fa-hashtag me-1"></i><%= course.courseCode %> • <i class="fas fa-graduation-cap ms-2 me-1"></i><%= course.year %> • <i class="fas fa-layer-group ms-2 me-1"></i><%= course.level %>
              </p>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-success" onclick="exportCourseToExcel()">
                <i class="fas fa-file-excel me-2"></i>Export to Excel
              </button>
              <a class="btn btn-outline-secondary" href="/admin/courses"><i class="fas fa-arrow-left me-2"></i>Back</a>
              <a class="btn btn-primary" href="/admin/courses/<%= course.courseCode %>/content"><i class="fas fa-edit me-2"></i>Manage Content</a>
            </div>
          </div>
        </div>

        <!-- Top Analytics -->
        <div class="admin-stats-grid">
          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon"><i class="fas fa-users"></i></div>
            </div>
            <h3 class="admin-stat-number"><%= analytics.totalEnrolled %></h3>
            <p class="admin-stat-label">Enrolled Students</p>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon"><i class="fas fa-percentage"></i></div>
            </div>
            <h3 class="admin-stat-number"><%= analytics.averageProgress %>%</h3>
            <p class="admin-stat-label">Average Progress</p>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon"><i class="fas fa-check-circle"></i></div>
            </div>
            <h3 class="admin-stat-number"><%= analytics.completionRate %>%</h3>
            <p class="admin-stat-label">Completion Rate</p>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-header">
              <div class="admin-stat-icon"><i class="fas fa-tasks"></i></div>
            </div>
            <h3 class="admin-stat-number"><%= analytics.contentCompletionRate %>%</h3>
            <p class="admin-stat-label">Content Completion</p>
          </div>
        </div>

        <!-- Tabs -->
        <div class="admin-content-card">
          <ul class="nav nav-tabs" id="courseTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab">Enrolled Students</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="topics-tab" data-bs-toggle="tab" data-bs-target="#topics" type="button" role="tab">Topics & Analytics</button>
            </li>
          </ul>
          <div class="tab-content p-3" id="courseTabsContent">
            <!-- Students Tab -->
            <div class="tab-pane fade show active" id="students" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Enrolled Students</h5>
                <div class="d-flex gap-2">
                  <input type="text" id="studentSearch" class="form-control form-control-sm" placeholder="Search name or email..." style="width: 240px;">
                </div>
              </div>
              <div class="students-table-container card-soft">
                <% if (students && students.length) { %>
                <div class="table-overflow">
                  <table class="table-pro" id="studentsTable">
                    <thead>
                      <tr>
                        <th class="col-min">#</th>
                        <th>Student</th>
                        <th>Student Code</th>
                        <th>Grade</th>
                        <th>School</th>
                        <th>Progress</th>
                        <th>Status</th>
                        <th>Enrolled</th>
                        <th>Last Accessed</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% students.forEach((s, idx) => { %>
                      <tr>
                        <td class="col-min" style="opacity: .7; font-weight: 600;"><%= idx+1 %></td>
                        <td>
                          <div class="student-profile">
                            <div class="student-avatar"><%= (s.name?.split(' ')[0]?.[0] || '').toUpperCase() %><%= (s.name?.split(' ')[1]?.[0] || '').toUpperCase() %></div>
                            <div class="student-info">
                              <div class="student-name"><%= s.name %></div>
                              <div class="student-email"><%= s.email %></div>
                            </div>
                          </div>
                        </td>
                        <td><%= s.studentCode %></td>
                        <td><%= s.grade || '-' %></td>
                        <td><%= s.schoolName || '-' %></td>
                        <td>
                          <div class="progress-bar-container">
                            <div class="progress-percentage"><%= s.progress %>%</div>
                            <div class="progress-bar">
                              <div class="progress-fill" style="width:<%= s.progress %>%"></div>
                            </div>
                          </div>
                        </td>
                        <td>
                          <span class="status-badge <%= s.status === 'completed' ? 'status-active' : 'status-inactive' %>">
                            <span class="status-icon"></span>
                            <%= s.status %>
                          </span>
                        </td>
                        <td><%= s.enrolledAt ? new Date(s.enrolledAt).toLocaleDateString() : '-' %></td>
                        <td><%= s.lastAccessed ? new Date(s.lastAccessed).toLocaleDateString() : '-' %></td>
                      </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
                <% } else { %>
                <div class="empty-state"><i class="fas fa-users"></i>
                  <h3>No enrolled students</h3>
                </div>
                <% } %>
              </div>
            </div>

            <!-- Topics Tab -->
            <div class="tab-pane fade" id="topics" role="tabpanel">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="fas fa-list-ol me-2"></i>Topics & Content Analytics</h5>
              </div>
              <% if (topicsAnalytics && topicsAnalytics.length) { %>
              <div class="accordion accordion-pro" id="topicsAccordion">
                <% topicsAnalytics.forEach((topic, tIdx) => { %>
                <div class="accordion-item">
                  <h2 class="accordion-header" id="heading-<%= topic._id %>">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-<%= topic._id %>" aria-expanded="false" aria-controls="collapse-<%= topic._id %>">
                      <span class="badge bg-secondary me-2">#<%= topic.order %></span>
                      <strong class="me-2"><%= topic.title %></strong>
                      <span class="topic-meta">
                        <span class="badge-soft"><i class="fas fa-file-alt me-1"></i><%= topic.contentCount %> items</span>
                        <span class="badge-soft"><i class="fas fa-eye me-1"></i><%= topic.totals.viewers %> views</span>
                        <span class="badge-soft"><i class="fas fa-check me-1"></i><%= topic.totals.completions %> done</span>
                      </span>
                    </button>
                  </h2>
                  <div id="collapse-<%= topic._id %>" class="accordion-collapse collapse" aria-labelledby="heading-<%= topic._id %>" data-bs-parent="#topicsAccordion">
                    <div class="accordion-body">
                      <div class="table-overflow card-soft">
                        <table class="table-pro">
                          <thead>
                            <tr>
                              <th class="col-min">#</th>
                              <th>Content</th>
                              <th>Type</th>
                              <th>Views</th>
                              <th>Completions</th>
                              <th>Avg Time (m)</th>
                              <th>Attempts</th>
                              <th>Avg Score</th>
                              <th>Pass Rate</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% topic.contents.sort((a,b)=>a.order-b.order).forEach((ci, cIdx) => { %>
                            <tr>
                              <td class="col-min" style="opacity:.7;font-weight:600"><%= cIdx+1 %></td>
                              <td><%= ci.title %></td>
                              <td><span class="content-type-badge content-type-<%= ci.type %>"><%= ci.type %></span></td>
                              <td><%= ci.viewers %></td>
                              <td><%= ci.completions %></td>
                              <td><%= ci.averageTimeSpent %></td>
                              <td><%= ci.attempts %></td>
                              <td><%= ci.averageScore !== null ? ci.averageScore + '%' : '-' %></td>
                              <td><%= ci.passRate !== null ? ci.passRate + '%' : '-' %></td>
                            </tr>
                            <% }) %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <% }) %>
              </div>
              <% } else { %>
              <div class="empty-state"><i class="fas fa-list"></i>
                <h3>No topics yet</h3>
              </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<%- include('./partials/admin-footer') %>

<script>
  // Simple client-side search in students table
  document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('studentSearch');
    if (!input) return;
    input.addEventListener('input', function() {
      const term = this.value.toLowerCase();
      document.querySelectorAll('#studentsTable tbody tr').forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
      });
    });
  });

  // Export course details to Excel
  async function exportCourseToExcel() {
    try {
      // Show loading state
      const button = event.target.closest('button');
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Exporting...';
      button.disabled = true;

      // Make request to export endpoint
      const response = await fetch(`/admin/courses/<%= course._id %>/export`, {
        method: 'GET',
        headers: {
          'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        }
      });

      if (!response.ok) {
        throw new Error('Export failed');
      }

      // Get the blob and create download link
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = `course-<%= course.courseCode %>-details-${new Date().toISOString().split('T')[0]}.xlsx`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);

      // Show success message
      showNotification('Course details exported successfully!', 'success');
    } catch (error) {
      console.error('Export error:', error);
      showNotification('Failed to export course details. Please try again.', 'error');
    } finally {
      // Restore button state
      const button = event.target.closest('button');
      button.innerHTML = originalText;
      button.disabled = false;
    }
  }

  // Simple notification function
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);

    // Auto remove after 5 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 5000);
  }
</script>