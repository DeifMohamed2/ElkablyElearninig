<%- include('partials/header', { title: title }) %>

<!-- Floating Math Elements -->
<div class="floating-math-elements-professor" id="floatingMath">
  <div class="math-element-professor" data-equation="∂">∂</div>
  <div class="math-element-professor" data-equation="∇">∇</div>
  <div class="math-element-professor" data-equation="∫">∫</div>
  <div class="math-element-professor" data-equation="∑">∑</div>
  <div class="math-element-professor" data-equation="∏">∏</div>
  <div class="math-element-professor" data-equation="∞">∞</div>
  <div class="math-element-professor" data-equation="∃">∃</div>
  <div class="math-element-professor" data-equation="∀">∀</div>
  <div class="math-element-professor" data-equation="ℝ">ℝ</div>
  <div class="math-element-professor" data-equation="ℂ">ℂ</div>
</div>

<!-- Bundle Content Section -->
<section class="bundle-content-section" style="margin-top: 60px;">
  <div class="container">
    <!-- Breadcrumb -->
    <nav class="breadcrumb-nav">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="/courses/<%= bundle.courseType %>"><%= bundle.courseType === 'online' ? 'Online' : bundle.courseType === 'recorded' ? 'Recorded' : bundle.courseType === 'recovery' ? 'Recovery' : 'On-Ground' %> Courses</a></li>
        <li class="breadcrumb-item active"><%= bundle.title %></li>
      </ol>
    </nav>

    <!-- Enhanced Search and Filter Section -->
    <div class="courses-filter-section-enhanced mb-3">
      <div class="filter-container">
        <div class="row align-items-center">
          <div class="col-lg-6">
            <form class="search-form-enhanced" method="GET">
              <div class="search-input-group-enhanced">

                <input type="text" name="search" class="search-input-enhanced" placeholder="Search weeks in this course..." value="">
                <button type="submit" class="search-btn-enhanced">
                  <span>Search</span>
                  <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Results Count -->
    <div class="results-count-enhanced mb-2">
      <div class="results-info">
        <div class="results-stats">
          <span class="results-number" id="filteredCount"><%= bundle.courses.length %></span>
          <span class="results-label">/ <%= bundle.courses.length %> weeks</span>
        </div>
        <div class="results-type">
          <i class="fas fa-<%= bundle.courseType === 'online' ? 'laptop-code' : bundle.courseType === 'recorded' ? 'video' : bundle.courseType === 'recovery' ? 'redo' : 'chalkboard-teacher' %>"></i>
          <span><%= bundle.courseType === 'online' ? 'Online' : bundle.courseType === 'recorded' ? 'Recorded' : bundle.courseType === 'recovery' ? 'Recovery' : 'On-Ground' %> Course</span>
        </div>
      </div>
    </div>

    <!-- Bundle Header -->
    <div class="bundle-content-header mb-3">
      <div class="row equal-height">
        <div class="col-lg-8">
          <div class="bundle-header-info">
            <div class="bundle-badge">
              <span class="badge-type">
                <i class="fas fa-<%= bundle.courseType === 'online' ? 'laptop' : bundle.courseType === 'recorded' ? 'video' : bundle.courseType === 'recovery' ? 'redo' : 'chalkboard-teacher' %>"></i>
                <%= bundle.courseType === 'online' ? 'Online' : bundle.courseType === 'recorded' ? 'Recorded' : bundle.courseType === 'recovery' ? 'Recovery' : 'On-Ground' %>
              </span>
              <span class="badge-year">
                <i class="fas fa-calendar"></i>

              </span>
              <span class="badge-subject">
                <i class="fas fa-book"></i>
                <%= bundle.subject %>
              </span>
            </div>
            <div class="bundle-title-container">
              <h1 class="bundle-title"><%= bundle.title %></h1>
              <div class="bundle-wishlist-btn" onclick="toggleWishlist('<%= bundle._id %>', 'bundle')" title="Add to Wishlist">
                <% if (user && user.isBundleInWishlist(bundle._id.toString())) { %>
                <i class="fas fa-heart" style="color: #ff6b6b;"></i>
                <% } else { %>
                <i class="far fa-heart"></i>
                <% } %>
              </div>
            </div>
            <p class="bundle-description"><%= bundle.description %></p>

            <div class="bundle-stats">
              <div class="stat-item">
                <i class="fas fa-book"></i>
                <span><%= bundle.courses.length %> Week<%= bundle.courses.length !== 1 ? 's' : '' %></span>
              </div>

              <div class="stat-item">
                <i class="fas fa-star"></i>
                <span>4.8 Rating</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="bundle-purchase-card h-100 d-flex flex-column">
            <div class="purchase-header">
              <div class="price-container">
                <% if (bundle.discountPrice) { %>
                <span class="price-original"><%= bundle.price %> EGP</span>
                <span class="price-current"><%= bundle.finalPrice.toFixed(2) %> EGP</span>
                <span class="price-savings">Save <%= bundle.savings.toFixed(2) %> EGP (<%= bundle.savingsPercentage %>% off)</span>
                <% } else { %>
                <span class="price-current"><%= bundle.price %> EGP</span>
                <% } %>
              </div>
            </div>

            <div class="purchase-actions">
              <% if (user && user.hasPurchasedBundle(bundle._id.toString())) { %>
              <button class="btn-purchased" disabled>
                <i class="fas fa-check-circle"></i>
                <span>Already Purchased</span>
              </button>
              <a href="/student/enrolled-courses" class="btn-access-courses">
                <i class="fas fa-graduation-cap"></i>
                <span>Access Courses</span>
              </a>
              <% } else if (bundle.isFullyBooked) { %>
              <button class="btn-fully-booked-enhanced" disabled>
                <i class="fas fa-ban"></i>
                <span class="fully-booked-text"><%= bundle.fullyBookedMessage || 'FULLY BOOKED' %></span>
              </button>
              <% } else { %>
              <button class="btn-add-to-cart" onclick="addBundleToCart('<%= bundle._id %>')">
                <i class="fas fa-shopping-cart"></i>
                <span>Add Bundle to Cart</span>
              </button>
              <a href="/purchase/checkout?bundle=<%= bundle._id %>" class="btn-buy-now">
                <i class="fas fa-credit-card"></i>
                <span>Buy Now</span>
              </a>
              <% } %>
            </div>


            <div class="bundle-info mt-auto">
              <div class="info-item">
                <i class="fas fa-headset"></i>
                <span>24/7 Support</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Courses Grid -->
    <div class="courses-content-grid">
      <h2 class="section-title">Weeks in this Course</h2>
      <div class="courses-grid" id="coursesGrid">
        <% 
          // Use coursesWithUnlockStatus if available, otherwise use bundle.courses
          const coursesToDisplay = coursesWithUnlockStatus && coursesWithUnlockStatus.length > 0 
            ? coursesWithUnlockStatus 
            : bundle.courses;
          
          // Sort courses by order before displaying
          const sortedCourses = [...coursesToDisplay].sort((a, b) => {
            const orderA = a.order || 0;
            const orderB = b.order || 0;
            return orderA - orderB;
          });
        %>
        <% sortedCourses.forEach((course, index) => { %>
        <% 
          const isEnrolled = user && (user.hasAccessToCourse(course._id.toString()) || user.hasAccessToCourseThroughBundle(course._id.toString(), bundle._id.toString()));
          // Check if course is unlocked (for enrolled students with startingOrder)
          const isUnlocked = course.isUnlocked !== undefined ? course.isUnlocked : true;
          const canAccess = isEnrolled && isUnlocked;
        %>
        <article class="course-card-enhanced <%= canAccess ? 'course-enrolled' : (isEnrolled && !isUnlocked ? 'course-locked' : '') %>" data-title="<%= course.title.toLowerCase() %>" data-course-id="<%= course._id %>" data-course-order="<%= course.order || 0 %>" data-requires-sequential="<%= course.requiresSequential !== false %>">
          <div class="course-card-header">
            <div class="course-favorite-btn-enhanced" onclick="toggleWishlist('<%= course._id %>', 'course')" title="Add to Wishlist">
              <% if (user && user.isCourseInWishlist(course._id.toString())) { %>
              <i class="fas fa-heart" style="color: #ff6b6b;"></i>
              <% } else { %>
              <i class="far fa-heart"></i>
              <% } %>
            </div>
            <div class="course-badge-container">
              <% if (canAccess) { %>
              <div class="course-offer-badge-enhanced enrolled">
                <i class="fas fa-check-circle"></i>
                <span>Enrolled</span>
              </div>
              <% } else if (isEnrolled && !isUnlocked) { %>
              <div class="course-offer-badge-enhanced locked">
                <i class="fas fa-lock"></i>
                <span>Locked</span>
              </div>
              <% } else if (course.discountPrice) { %>
              <div class="course-offer-badge-enhanced discount">
                <i class="fas fa-percentage"></i>
                <span>Save <%= course.savingsPercentage %>%</span>
              </div>
              <% } %>
            </div>
          </div>

          <div class="course-card-media-enhanced">
            <img src="<%= course.thumbnail || '/images/adad.png' %>" alt="<%= course.title %>" loading="lazy">
            <div class="course-overlay-enhanced">
              <div class="course-quick-actions">
                <% if (canAccess) { %>
                <button class="quick-action-btn enrolled" title="Access Course" onclick="accessCourse('<%= course._id %>')">
                  <i class="fas fa-graduation-cap"></i>
                </button>
                <% } else if (isEnrolled && !isUnlocked) { %>
                <button class="quick-action-btn locked" title="<%= course.unlockReason || 'Course Locked' %>" disabled>
                  <i class="fas fa-lock"></i>
                </button>
                <% } else if (course.isFullyBooked || (bundle.isFullyBooked && !course.isFullyBooked)) { %>
                <button class="quick-action-btn fully-booked" title="<%= course.isFullyBooked ? (course.fullyBookedMessage || 'FULLY BOOKED') : (bundle.fullyBookedMessage || 'FULLY BOOKED') %>" disabled style="background-color: #dc3545; cursor: not-allowed;">
                  <i class="fas fa-ban"></i>
                </button>
                <% } else { %>
                <button class="quick-action-btn" onclick="addCourseToCart('<%= course._id %>')" title="Add to Cart">
                  <i class="fas fa-shopping-cart"></i>
                </button>
                <% } %>

              </div>
            </div>
          </div>

          <div class="course-card-body-enhanced">
            <div class="course-meta">
              <!-- <span class="course-year"><%= course.year %></span> -->
              <span class="course-subject"><%= course.subject %></span>
            </div>

            <h3 class="course-card-title-enhanced"><%= course.title %></h3>
            <p class="course-card-description-enhanced">
              <%= course.shortDescription ||""%>
            </p>

            <div class="course-stats-enhanced">
              <div class="stat-item">
                <i class="fas fa-book"></i>
                <span><%= course.category %></span>
              </div>

            </div>

            <div class="course-price-container-enhanced">
              <% if (canAccess) { %>
              <div class="price-wrapper">
                <span class="course-price-enrolled">
                  <i class="fas fa-check-circle"></i>
                  <span>Included in Bundle</span>
                </span>
              </div>
              <% } else if (isEnrolled && !isUnlocked) { %>
              <div class="price-wrapper">
                <span class="course-price-locked">
                  <i class="fas fa-lock"></i>
                  <span><%= course.unlockReason || 'Complete previous weeks first' %></span>
                </span>
              </div>
              <% } else if (course.discountPrice) { %>
              <div class="price-wrapper">
                <span class="course-price-original-enhanced"><%= course.price %> EGP</span>
                <span class="course-price-current-enhanced"><%= course.finalPrice.toFixed(2) %> EGP</span>
              </div>
              <div class="savings-info">
                <span class="savings-amount">Save <%= course.savings.toFixed(2) %> EGP</span>
              </div>
              <% } else { %>
              <div class="price-wrapper">
                <span class="course-price-current-enhanced"><%= course.price %> EGP</span>
              </div>
              <% } %>
            </div>

            <div class="course-actions-enhanced">
              <% if (canAccess) { %>
              <button class="btn-access-course-enhanced" onclick="accessCourse('<%= course._id %>')">
                <i class="fas fa-graduation-cap"></i>
                <span>Access Course</span>
              </button>
              <% } else if (isEnrolled && !isUnlocked) { %>
              <button class="btn-access-course-enhanced" disabled style="opacity: 0.6; cursor: not-allowed;" title="<%= course.unlockReason || 'Complete previous weeks first' %>">
                <i class="fas fa-lock"></i>
                <span>Locked</span>
              </button>
              <% } else if (course.isFullyBooked || (bundle.isFullyBooked && !course.isFullyBooked)) { %>
              <button class="btn-fully-booked-enhanced" disabled>
                <i class="fas fa-ban"></i>
                <span class="fully-booked-text"><%= course.isFullyBooked ? (course.fullyBookedMessage || 'FULLY BOOKED') : (bundle.fullyBookedMessage || 'FULLY BOOKED') %></span>
              </button>
              <% } else { %>
              <button class="btn-add-to-cart-enhanced" onclick="addCourseToCart('<%= course._id %>')">
                <i class="fas fa-shopping-cart"></i>
                <span>Add to Cart</span>
              </button>
              <% } %>
            </div>

            <!-- Content Preview Toggle -->
            <% if (course.topics && course.topics.length > 0) { %>
            <div class="content-preview-toggle">
              <button class="btn-toggle-content" onclick="toggleContentPreview('<%= course._id %>', event)" data-course-id="<%= course._id %>">
                <div class="toggle-content-info">
                  <i class="fas fa-layer-group"></i>
                  <span>What's Inside</span>
                </div>
                <div class="toggle-right-section">
                  <span class="content-count-badge"><%= course.topics.length %></span>
                  <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
              </button>
            </div>
            <% } %>
          </div>

          <!-- Expandable Content Preview Section -->
          <% if (course.topics && course.topics.length > 0) { %>
          <div class="content-preview-section" id="contentPreview-<%= course._id %>" style="display: none;">
            <div class="content-preview-wrapper">
              <% 
                // Sort topics by order
                const sortedTopics = [...course.topics].sort((a, b) => (a.order || 0) - (b.order || 0));
              %>
              <% sortedTopics.forEach((topic, topicIndex) => { %>
              <div class="topic-preview-item">
                <div class="topic-preview-header" onclick="toggleTopicContent('<%= course._id %>-<%= topic._id %>', event)">
                  <div class="topic-info">
                    <span class="topic-number"><%= topicIndex + 1 %></span>
                    <div class="topic-details">
                      <h4 class="topic-title"><%= topic.title %></h4>
                      <% if (topic.description) { %>
                      <p class="topic-description"><%= topic.description %></p>
                      <% } %>
                    </div>
                  </div>
                  <div class="topic-meta">
                    <% if (topic.content && topic.content.length > 0) { %>
                    <span class="topic-content-count">
                      <i class="fas fa-folder-open"></i>
                      <%= topic.content.length %> item<%= topic.content.length !== 1 ? 's' : '' %>
                    </span>
                    <% } %>
                    <% if (topic.estimatedTime) { %>
                    <span class="topic-duration">
                      <i class="fas fa-clock"></i>
                      <%= topic.estimatedTime %> min
                    </span>
                    <% } %>
                    <i class="fas fa-chevron-down topic-toggle-icon"></i>
                  </div>
                </div>

                <!-- Topic Content Items -->
                <% if (topic.content && topic.content.length > 0) { %>
                <div class="topic-content-items" id="topicContent-<%= course._id %>-<%= topic._id %>" style="display: none;">
                  <% 
                    // Sort content by order
                    const sortedContent = [...topic.content].sort((a, b) => (a.order || 0) - (b.order || 0));
                  %>
                  <% sortedContent.forEach((contentItem, contentIndex) => { %>
                  <div class="content-item-preview">
                    <div class="content-item-icon">
                      <% if (contentItem.type === 'video') { %>
                      <i class="fas fa-play-circle" style="color: #e74c3c;"></i>
                      <% } else if (contentItem.type === 'pdf') { %>
                      <i class="fas fa-file-pdf" style="color: #3498db;"></i>
                      <% } else if (contentItem.type === 'quiz') { %>
                      <i class="fas fa-question-circle" style="color: #9b59b6;"></i>
                      <% } else if (contentItem.type === 'homework') { %>
                      <i class="fas fa-pencil-alt" style="color: #f39c12;"></i>
                      <% } else if (contentItem.type === 'reading') { %>
                      <i class="fas fa-book-open" style="color: #27ae60;"></i>
                      <% } else if (contentItem.type === 'link') { %>
                      <i class="fas fa-external-link-alt" style="color: #1abc9c;"></i>
                      <% } else if (contentItem.type === 'zoom') { %>
                      <i class="fas fa-video" style="color: #2d8cff;"></i>
                      <% } else { %>
                      <i class="fas fa-file" style="color: #95a5a6;"></i>
                      <% } %>
                    </div>
                    <div class="content-item-info">
                      <span class="content-item-title"><%= contentItem.title %></span>
                      <div class="content-item-meta">
                        <span class="content-type-badge <%= contentItem.type %>"><%= contentItem.type.charAt(0).toUpperCase() + contentItem.type.slice(1) %></span>
                        <% if (contentItem.duration) { %>
                        <span class="content-duration"><i class="fas fa-clock"></i> <%= contentItem.duration %> min</span>
                        <% } %>
                      </div>
                    </div>
                  </div>
                  <% }); %>
                </div>
                <% } else { %>
                <div class="topic-no-content">
                  <i class="fas fa-info-circle"></i>
                  <span>Content coming soon</span>
                </div>
                <% } %>
              </div>
              <% }); %>
            </div>
          </div>
          <% } %>
        </article>
        <% }); %>
      </div>

      <!-- No Courses Found Message -->
      <div class="no-courses-found-enhanced" id="noCoursesFound" style="display: none;">
        <div class="no-courses-content">
          <div class="no-courses-icon-enhanced">
            <div class="icon-background">
              <i class="fas fa-search"></i>
            </div>
          </div>
          <h3 class="no-courses-title">No Courses Found</h3>
          <p class="no-courses-description">
            We couldn't find any courses matching your search criteria.
            Try adjusting your filters or search terms.
          </p>
          <div class="no-courses-actions">
            <button class="btn-secondary-enhanced" onclick="clearFilters()">
              <i class="fas fa-refresh"></i>
              <span>Clear Filters</span>
            </button>
          </div>
        </div>
      </div>
    </div>


  </div>
</section>

<script>
  // Add course to cart functionality
  function addCourseToCart(courseId) {
    // Check if user is logged in
    <% if (!user) { %>
    showCartNotification('Please login to add items to cart', 'error');
    setTimeout(() => {
      window.location.href = '/auth/login';
    }, 3500); // Increased delay
    return;
    <% } %>

    // Find the course data from the page
    const courseCard = document.querySelector(`[onclick="addCourseToCart('${courseId}')"]`).closest('.course-card-enhanced');
    const courseTitle = courseCard.querySelector('.course-card-title-enhanced').textContent;
    const courseImage = courseCard.querySelector('.course-card-media-enhanced img').src;

    // Get the individual course price (final price after discount if any)
    const priceElement = courseCard.querySelector('.course-price-current-enhanced');
    const coursePrice = parseFloat(priceElement.textContent.replace('$', ''));

    // Show loading state
    const btn = courseCard.querySelector('.btn-add-to-cart-enhanced');
    const originalText = btn.querySelector('span').textContent;
    const icon = btn.querySelector('i');

    btn.disabled = true;
    btn.querySelector('span').textContent = 'Adding...';
    icon.classList.remove('fa-shopping-cart');
    icon.classList.add('fa-spinner', 'fa-spin');

    // Add to cart via API
    fetch('/purchase/cart/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          itemId: courseId,
          itemType: 'course',
          title: courseTitle,
          price: coursePrice,
          image: courseImage
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Visual feedback
          btn.style.background = '#27ae60';
          btn.querySelector('span').textContent = 'Added!';
          icon.classList.remove('fa-spinner', 'fa-spin');
          icon.classList.add('fa-check');

          showCartNotification(data.message, 'success');

          // Update global cart count and refresh cart data
          if (window.globalCart) {
            window.globalCart.refreshCartData();
          }

          setTimeout(() => {
            btn.disabled = false;
            btn.style.background = '';
            btn.querySelector('span').textContent = originalText;
            icon.classList.remove('fa-check');
            icon.classList.add('fa-shopping-cart');
          }, 2000);
        } else {
          btn.disabled = false;
          btn.querySelector('span').textContent = originalText;
          icon.classList.remove('fa-spinner', 'fa-spin');
          icon.classList.add('fa-shopping-cart');

          showCartNotification(data.message || 'Failed to add item to cart', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        btn.disabled = false;
        btn.querySelector('span').textContent = originalText;
        icon.classList.remove('fa-spinner', 'fa-spin');
        icon.classList.add('fa-shopping-cart');

        showCartNotification('Network error. Please try again.', 'error');
      });
  }

  // Add bundle to cart functionality
  function addBundleToCart(bundleId) {
    // Check if user is logged in
    <% if (!user) { %>
    showCartNotification('Please login to add items to cart', 'error');
    setTimeout(() => {
      window.location.href = '/auth/login';
    }, 3500); // Increased delay
    return;
    <% } %>

    // Get bundle data from the page
    const bundleTitle = document.querySelector('.bundle-title').textContent;
    const priceElement = document.querySelector('.price-current');
    const price = parseFloat(priceElement.textContent.replace('$', ''));
    const image = '/images/adad.png'; // Default bundle image

    // Show loading state
    const btn = document.querySelector('.btn-add-to-cart');
    const originalText = btn.querySelector('span').textContent;
    const icon = btn.querySelector('i');

    btn.disabled = true;
    btn.querySelector('span').textContent = 'Adding...';
    icon.classList.remove('fa-shopping-cart');
    icon.classList.add('fa-spinner', 'fa-spin');

    // Add to cart via API
    fetch('/purchase/cart/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          itemId: bundleId,
          itemType: 'bundle',
          title: bundleTitle,
          price: price,
          image: image
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Visual feedback
          btn.style.background = '#27ae60';
          btn.querySelector('span').textContent = 'Added!';
          icon.classList.remove('fa-spinner', 'fa-spin');
          icon.classList.add('fa-check');

          showCartNotification(data.message, 'success');

          // Update global cart count and refresh cart data
          if (window.globalCart) {
            window.globalCart.refreshCartData();
          }

          setTimeout(() => {
            btn.disabled = false;
            btn.style.background = '';
            btn.querySelector('span').textContent = originalText;
            icon.classList.remove('fa-check');
            icon.classList.add('fa-shopping-cart');
          }, 2000);
        } else {
          btn.disabled = false;
          btn.querySelector('span').textContent = originalText;
          icon.classList.remove('fa-spinner', 'fa-spin');
          icon.classList.add('fa-shopping-cart');

          showCartNotification(data.message || 'Failed to add item to cart', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        btn.disabled = false;
        btn.querySelector('span').textContent = originalText;
        icon.classList.remove('fa-spinner', 'fa-spin');
        icon.classList.add('fa-shopping-cart');

        showCartNotification('Network error. Please try again.', 'error');
      });
  }

  // Course Filtering Functionality
  function filterCourses() {
    const searchInput = document.querySelector('.search-input-enhanced');
    const coursesGrid = document.getElementById('coursesGrid');
    const noCoursesFound = document.getElementById('noCoursesFound');
    const filteredCount = document.getElementById('filteredCount');

    const searchTerm = searchInput.value.toLowerCase();

    const courseCards = document.querySelectorAll('.course-card-enhanced');
    let visibleCount = 0;

    courseCards.forEach(card => {
      const title = card.getAttribute('data-title');

      const matchesSearch = title.includes(searchTerm);

      if (matchesSearch) {
        card.style.display = 'block';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    // Update filtered count
    filteredCount.textContent = visibleCount;

    // Show/hide no courses found message
    if (visibleCount === 0) {
      noCoursesFound.style.display = 'flex';
      coursesGrid.style.display = 'none';
    } else {
      noCoursesFound.style.display = 'none';
      coursesGrid.style.display = 'grid';
    }
  }

  // Clear filters function
  function clearFilters() {
    document.querySelector('.search-input-enhanced').value = '';
    filterCourses();
  }

  // Enhanced interactions (no delay animations)
  document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects to course cards
    document.querySelectorAll('.course-card-enhanced').forEach(card => {
      card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-5px)';
      });

      card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
      });
    });

    // Add click effects to buttons
    document.querySelectorAll('.btn-add-to-cart, .btn-buy-now, .btn-add-to-cart-enhanced').forEach(btn => {
      btn.addEventListener('click', function(e) {
        // Create ripple effect
        const ripple = document.createElement('span');
        const rect = this.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;

        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        ripple.classList.add('ripple');

        this.appendChild(ripple);

        setTimeout(() => {
          ripple.remove();
        }, 600);
      });
    });

    // Add search functionality
    const searchInput = document.querySelector('.search-input-enhanced');
    if (searchInput) {
      searchInput.addEventListener('input', filterCourses);
    }
  });

  // Access course function for enrolled courses
  function accessCourse(courseId) {
    // Redirect to the course content or student dashboard
    window.location.href = `/student/enrolled-courses`;
  }

  // Toggle content preview for a course/week - Professional Modal/Drawer approach
  function toggleContentPreview(courseId, event) {
    // Prevent event bubbling
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }

    // Find the button that was clicked
    const clickedBtn = event.currentTarget;
    // Find the course card containing this button
    const courseCard = clickedBtn.closest('.course-card-enhanced');
    // Find the content section within this specific card
    const contentSection = courseCard.querySelector('.content-preview-section');

    if (!contentSection || !clickedBtn) {
      console.log('Could not find elements for course:', courseId);
      return;
    }

    // Get course info for the modal
    const courseTitle = courseCard.querySelector('.course-card-title-enhanced').textContent;
    const courseImage = courseCard.querySelector('.course-card-media-enhanced img')?.src || '/images/adad.png';

    // Create or get the modal
    let modal = document.getElementById('contentPreviewModal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'contentPreviewModal';
      modal.className = 'content-preview-modal';
      modal.innerHTML = `
        <div class="content-modal-backdrop"></div>
        <div class="content-modal-drawer">
          <div class="drawer-header">
            <div class="drawer-header-content">
              <div class="drawer-course-info">
                <img src="" alt="" class="drawer-course-thumb">
                <div class="drawer-course-details">
                  <span class="drawer-label">Course Content</span>
                  <h3 class="drawer-course-title"></h3>
                </div>
              </div>
              <button class="drawer-close-btn" onclick="closeContentModal()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="drawer-progress-bar">
              <div class="drawer-progress-fill"></div>
            </div>
          </div>
          <div class="drawer-body">
            <div class="drawer-content-wrapper"></div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Close on backdrop click
      modal.querySelector('.content-modal-backdrop').addEventListener('click', closeContentModal);

      // Close on escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeContentModal();
      });
    }

    // Update modal content
    modal.querySelector('.drawer-course-thumb').src = courseImage;
    modal.querySelector('.drawer-course-title').textContent = courseTitle;
    modal.querySelector('.drawer-content-wrapper').innerHTML = contentSection.innerHTML;

    // Show modal with animation
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    clickedBtn.classList.add('active');

    // Store reference to current button
    modal.dataset.currentBtn = courseId;
  }

  // Close content modal
  function closeContentModal() {
    const modal = document.getElementById('contentPreviewModal');
    if (modal) {
      modal.classList.remove('active');
      document.body.style.overflow = '';

      // Remove active state from button
      const courseId = modal.dataset.currentBtn;
      const btn = document.querySelector(`[data-course-id="${courseId}"]`);
      if (btn) btn.classList.remove('active');
    }
  }

  // Toggle individual topic content
  function toggleTopicContent(topicId, event) {
    // Prevent event bubbling
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }

    // Find the clicked header
    const clickedHeader = event.currentTarget;
    // Find the topic item containing this header
    const topicItem = clickedHeader.closest('.topic-preview-item');
    // Find the content items within this specific topic
    const contentItems = topicItem.querySelector('.topic-content-items');

    if (!contentItems || !topicItem) {
      console.log('Could not find elements for topic:', topicId);
      return;
    }

    const isVisible = contentItems.style.display !== 'none';

    if (isVisible) {
      // Hide content
      contentItems.style.maxHeight = '0';
      contentItems.style.opacity = '0';
      setTimeout(() => {
        contentItems.style.display = 'none';
      }, 250);
      topicItem.classList.remove('expanded');
    } else {
      // Show content
      contentItems.style.display = 'block';
      setTimeout(() => {
        contentItems.style.maxHeight = '1000px';
        contentItems.style.opacity = '1';
      }, 10);
      topicItem.classList.add('expanded');
    }
  }

  // Show cart notification (consistent across all pages)
  function showCartNotification(message, type = 'success') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `cart-notification cart-notification-${type}`;

    // Choose icon based on type
    const iconClass = type === 'success' ? 'fas fa-check-circle' :
      type === 'error' ? 'fas fa-exclamation-circle' :
      'fas fa-info-circle';

    notification.innerHTML = `
    <div class="cart-notification-content">
      <i class="${iconClass}"></i>
      <span>${message}</span>
    </div>
  `;

    document.body.appendChild(notification);

    // Show notification
    setTimeout(() => notification.classList.add('show'), 100);

    // Calculate duration based on message length and type
    // Error messages, especially ordering errors, need more time to read
    let duration = 4000; // Default 4 seconds
    if (type === 'error') {
      // For error messages, calculate based on message length
      // Minimum 6 seconds, add 1 second per 50 characters
      duration = Math.max(6000, 6000 + (message.length / 50) * 1000);
      // Cap at 15 seconds for very long messages
      duration = Math.min(duration, 15000);
    } else if (type === 'success') {
      duration = 3000; // Success messages are shorter
    }

    // Hide notification
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => notification.remove(), 300);
    }, duration);
  }

  // Alias for backward compatibility
  function showNotification(message, type = 'info') {
    showCartNotification(message, type);
  }

  // Add ripple effect CSS for enhanced interactions
  const style = document.createElement('style');
  style.textContent = `
  .btn-add-to-cart, .btn-buy-now, .btn-add-to-cart-enhanced {
    position: relative;
    overflow: hidden;
  }
  
  .ripple {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.6);
    transform: scale(0);
    animation: ripple-animation 0.6s linear;
    pointer-events: none;
  }
  
  @keyframes ripple-animation {
    to {
      transform: scale(4);
      opacity: 0;
    }
  }

  /* Enhanced equal height layout for bundle header */
  .equal-height {
    display: flex;
    flex-wrap: wrap;
  }
  
  .equal-height > [class*="col-"] {
    display: flex;
    flex-direction: column;
  }

  /* Enrolled Course Styles */
  .course-card-enhanced.course-enrolled {
    border: 2px solid #27ae60;
    background: linear-gradient(135deg, rgba(39, 174, 96, 0.05), rgba(39, 174, 96, 0.02));
    position: relative;
    overflow: hidden;
  }

  .course-card-enhanced.course-enrolled::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #27ae60, #2ecc71, #27ae60);
    z-index: 1;
  }

  .course-card-enhanced.course-enrolled:hover {
    border-color: #2ecc71;
    box-shadow: 0 20px 40px rgba(39, 174, 96, 0.2);
    transform: translateY(-5px);
  }

  .course-offer-badge-enhanced.enrolled {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
  }

  .course-offer-badge-enhanced.enrolled i {
    color: white;
  }

  .course-offer-badge-enhanced.locked {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
  }

  .course-offer-badge-enhanced.locked i {
    color: white;
  }

  .quick-action-btn.enrolled {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
  }

  .quick-action-btn.enrolled:hover {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
  }

  .quick-action-btn.locked {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    cursor: not-allowed;
    opacity: 0.8;
  }

  .quick-action-btn.locked:hover {
    opacity: 0.9;
  }

  .quick-action-btn.fully-booked {
    background: linear-gradient(135deg, #dc3545, #c82333) !important;
    color: white !important;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
    cursor: not-allowed;
    opacity: 1;
  }

  .quick-action-btn.fully-booked:hover {
    opacity: 0.9;
    transform: none;
  }

  .course-price-enrolled {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.1rem;
    font-weight: 600;
    color: #27ae60;
    background: rgba(39, 174, 96, 0.1);
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 1px solid rgba(39, 174, 96, 0.2);
  }

  .course-price-enrolled i {
    color: #27ae60;
  }

  .course-price-locked {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    color: #e74c3c;
    background: rgba(231, 76, 60, 0.1);
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 1px solid rgba(231, 76, 60, 0.2);
  }

  .course-price-locked i {
    color: #e74c3c;
  }

  .btn-access-course-enhanced {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
  }

  .btn-access-course-enhanced:hover {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
    color: white;
    text-decoration: none;
  }

  .btn-access-course-enhanced i {
    transition: transform 0.3s ease;
  }

  .btn-access-course-enhanced:hover i {
    transform: scale(1.1);
  }

  /* Dark theme enrolled course styles */
  .dark-theme .course-card-enhanced.course-enrolled {
    background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(39, 174, 96, 0.05));
    border-color: #27ae60;
  }

  .dark-theme .course-card-enhanced.course-enrolled:hover {
    border-color: #2ecc71;
    box-shadow: 0 20px 40px rgba(39, 174, 96, 0.3);
  }

  .dark-theme .course-price-enrolled {
    background: rgba(39, 174, 96, 0.15);
    border-color: rgba(39, 174, 96, 0.3);
    color: #2ecc71;
  }

  .dark-theme .course-price-enrolled i {
    color: #2ecc71;
  }

  /* Course Order Badge */
  .course-order-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    background: rgba(52, 152, 219, 0.1);
    border: 1px solid rgba(52, 152, 219, 0.3);
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    color: #3498db;
    margin-top: 0.25rem;
  }

  .course-order-badge i {
    font-size: 0.7rem;
  }

  .dark-theme .course-order-badge {
    background: rgba(52, 152, 219, 0.15);
    border-color: rgba(52, 152, 219, 0.4);
    color: #60a5fa;
  }

  /* Course locked state (when order requirements not met) */
  .course-card-enhanced.course-locked {
    opacity: 0.7;
    position: relative;
  }

  .course-card-enhanced.course-locked::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    z-index: 1;
    pointer-events: none;
  }

  .course-card-enhanced.course-locked .btn-add-to-cart-enhanced {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .course-lock-message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(231, 76, 60, 0.95);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    z-index: 2;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    display: none;
  }

  .course-card-enhanced.course-locked:hover .course-lock-message {
    display: block;
  }

  /* Course Order Display in Body */
  .course-order-display {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.75rem;
    background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(52, 152, 219, 0.15) 100%);
    border: 1.5px solid rgba(52, 152, 219, 0.3);
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
    color: #2980b9;
    margin-left: 0.75rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(52, 152, 219, 0.1);
  }

  .course-order-display:hover {
    background: linear-gradient(135deg, rgba(52, 152, 219, 0.15) 0%, rgba(52, 152, 219, 0.2) 100%);
    border-color: rgba(52, 152, 219, 0.5);
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2);
  }

  .course-order-display i {
    font-size: 0.75rem;
    color: #3498db;
  }

  .course-meta {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .course-subject {
    display: inline-block;
  }

  /* Dark theme support for order display */
  .dark-theme .course-order-display {
    background: linear-gradient(135deg, rgba(52, 152, 219, 0.15) 0%, rgba(52, 152, 219, 0.2) 100%);
    border-color: rgba(52, 152, 219, 0.4);
    color: #60a5fa;
  }

  .dark-theme .course-order-display:hover {
    background: linear-gradient(135deg, rgba(52, 152, 219, 0.2) 0%, rgba(52, 152, 219, 0.25) 100%);
    border-color: rgba(52, 152, 219, 0.6);
  }

  .dark-theme .course-order-display i {
    color: #60a5fa;
  }

  /* ==========================================
     Content Preview Toggle Styles - Professional Modal/Drawer Design
     ========================================== */
  
  /* Toggle Button Container */
  .content-preview-toggle {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px dashed rgba(184, 1, 1, 0.15);
  }

  .btn-toggle-content {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: linear-gradient(135deg, #fff 0%, #fefefe 100%);
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: inherit;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .btn-toggle-content:hover {
    background: linear-gradient(135deg, #fef2f2 0%, #fff5f5 100%);
    border-color: #B80101;
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(184, 1, 1, 0.12);
  }

  .btn-toggle-content.active {
    background: linear-gradient(135deg, #B80101 0%, #9a0101 100%);
    border-color: #B80101;
    box-shadow: 0 4px 20px rgba(184, 1, 1, 0.3);
  }

  .btn-toggle-content.active .toggle-content-info > i,
  .btn-toggle-content.active .toggle-content-info > span,
  .btn-toggle-content.active .toggle-icon {
    color: white;
  }

  .btn-toggle-content.active .content-count-badge {
    background: white;
    color: #B80101;
  }

  .toggle-content-info {
    display: flex;
    align-items: center;
    gap: 0.625rem;
  }

  .toggle-content-info > i {
    font-size: 1rem;
    color: #B80101;
    transition: color 0.3s ease;
  }

  .toggle-content-info > span {
    font-weight: 600;
    color: #374151;
    font-size: 0.9rem;
    transition: color 0.3s ease;
  }

  .toggle-right-section {
    display: flex;
    align-items: center;
    gap: 0.625rem;
  }

  .content-count-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 26px;
    height: 26px;
    padding: 0 0.5rem;
    background: linear-gradient(135deg, #B80101 0%, #9a0101 100%);
    color: white;
    border-radius: 13px;
    font-size: 0.75rem;
    font-weight: 700;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(184, 1, 1, 0.25);
  }

  .toggle-icon {
    color: #9ca3af;
    font-size: 0.85rem;
    transition: all 0.3s ease;
  }

  .btn-toggle-content.active .toggle-icon {
    transform: rotate(180deg);
  }

  /* Hidden original content preview section (content is shown in modal) */
  .content-preview-section {
    display: none !important;
  }

  /* ==========================================
     Professional Content Preview Modal/Drawer
     ========================================== */
  
  .content-preview-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 99999;
    display: flex;
    justify-content: flex-end;
    opacity: 0;
    visibility: hidden;
    transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .content-preview-modal.active {
    opacity: 1;
    visibility: visible;
  }

  .content-modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0);
    backdrop-filter: blur(0px);
    transition: all 0.35s ease;
  }

  .content-preview-modal.active .content-modal-backdrop {
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  .content-modal-drawer {
    position: relative;
    width: 100%;
    max-width: 520px;
    height: 100%;
    background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
    box-shadow: -20px 0 60px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .content-preview-modal.active .content-modal-drawer {
    transform: translateX(0);
  }

  /* Drawer Header */
  .drawer-header {
    background: linear-gradient(135deg, #B80101 0%, #8a0000 100%);
    padding: 0;
    position: relative;
    flex-shrink: 0;
  }

  .drawer-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.5;
    pointer-events: none;
  }

  .drawer-header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem 1.5rem;
    position: relative;
    z-index: 1;
  }

  .drawer-course-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
    min-width: 0;
  }

  .drawer-course-thumb {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    object-fit: cover;
    border: 3px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    flex-shrink: 0;
  }

  .drawer-course-details {
    flex: 1;
    min-width: 0;
  }

  .drawer-label {
    display: inline-block;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 0.25rem;
  }

  .drawer-course-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: white;
    margin: 0;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .drawer-close-btn {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.2);
    color: white;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.25s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .drawer-close-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.4);
    transform: scale(1.05);
  }

  .drawer-progress-bar {
    height: 4px;
    background: rgba(0, 0, 0, 0.2);
    position: relative;
  }

  .drawer-progress-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #ffd700, #ffed4e);
    transition: width 0.5s ease;
  }

  /* Drawer Body */
  .drawer-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    overscroll-behavior: contain;
  }

  .drawer-body::-webkit-scrollbar {
    width: 6px;
  }

  .drawer-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }

  .drawer-body::-webkit-scrollbar-thumb {
    background: #B80101;
    border-radius: 3px;
  }

  .drawer-body::-webkit-scrollbar-thumb:hover {
    background: #9a0101;
  }

  .drawer-content-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .content-preview-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  /* Topic Preview Item - Enhanced Professional Design */
  .topic-preview-item {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    border: 2px solid #f0f0f0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .topic-preview-item:hover {
    border-color: #e0e0e0;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
  }

  .topic-preview-item.expanded {
    border-color: #B80101;
    box-shadow: 0 8px 32px rgba(184, 1, 1, 0.15);
    transform: translateY(-2px);
  }

  .topic-preview-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    cursor: pointer;
    transition: all 0.25s ease;
    gap: 1rem;
  }

  .topic-preview-header:hover {
    background: linear-gradient(135deg, #fef7f7 0%, #fff 100%);
  }

  .topic-preview-item.expanded .topic-preview-header {
    background: linear-gradient(135deg, #fef2f2 0%, #fff5f5 100%);
    border-bottom: 2px solid rgba(184, 1, 1, 0.1);
  }

  .topic-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
    min-width: 0;
  }

  .topic-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    min-width: 36px;
    background: linear-gradient(135deg, #B80101 0%, #9a0101 100%);
    color: white;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: 700;
    box-shadow: 0 3px 10px rgba(184, 1, 1, 0.25);
    transition: all 0.3s ease;
  }

  .topic-preview-item:hover .topic-number {
    transform: scale(1.05);
    box-shadow: 0 4px 14px rgba(184, 1, 1, 0.35);
  }

  .topic-details {
    flex: 1;
    min-width: 0;
  }

  .topic-title {
    font-size: 0.95rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .topic-description {
    font-size: 0.8rem;
    color: #6b7280;
    margin: 0.35rem 0 0 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .topic-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  .topic-content-count,
  .topic-duration {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.75rem;
    color: #4b5563;
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    padding: 0.4rem 0.75rem;
    border-radius: 20px;
    font-weight: 600;
    border: 1px solid #e5e7eb;
  }

  .topic-content-count i,
  .topic-duration i {
    font-size: 0.7rem;
    color: #B80101;
  }

  .topic-toggle-icon {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f3f4f6;
    border-radius: 8px;
    color: #6b7280;
    font-size: 0.75rem;
    transition: all 0.3s ease;
    margin-left: 0.25rem;
  }

  .topic-preview-item:hover .topic-toggle-icon {
    background: #e5e7eb;
    color: #374151;
  }

  .topic-preview-item.expanded .topic-toggle-icon {
    transform: rotate(180deg);
    background: #B80101;
    color: white;
  }

  /* Topic Content Items - Enhanced Professional Design */
  .topic-content-items {
    padding: 0 1.25rem 1.25rem 1.25rem;
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.35s ease;
    background: linear-gradient(180deg, #fafafa 0%, #f5f5f5 100%);
  }

  .content-item-preview {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.875rem 1rem;
    background: white;
    border-radius: 12px;
    margin-top: 0.625rem;
    border: 2px solid #f0f0f0;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
  }

  .content-item-preview:first-child {
    margin-top: 1rem;
  }

  .content-item-preview:hover {
    border-color: #B80101;
    background: linear-gradient(135deg, #fff 0%, #fef7f7 100%);
    transform: translateX(8px);
    box-shadow: 0 4px 16px rgba(184, 1, 1, 0.1);
  }

  .content-item-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    min-width: 44px;
    border-radius: 12px;
    transition: all 0.3s ease;
  }

  .content-item-icon i {
    font-size: 1.1rem;
  }

  /* Icon backgrounds based on content type */
  .content-item-preview:has(.content-type-badge.video) .content-item-icon {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
  }
  .content-item-preview:has(.content-type-badge.pdf) .content-item-icon {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
  }
  .content-item-preview:has(.content-type-badge.quiz) .content-item-icon {
    background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
  }
  .content-item-preview:has(.content-type-badge.homework) .content-item-icon {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  }
  .content-item-preview:has(.content-type-badge.reading) .content-item-icon {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
  }
  .content-item-preview:has(.content-type-badge.link) .content-item-icon {
    background: linear-gradient(135deg, #ccfbf1 0%, #99f6e4 100%);
  }
  .content-item-preview:has(.content-type-badge.zoom) .content-item-icon {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
  }

  .content-item-info {
    flex: 1;
    min-width: 0;
  }

  .content-item-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #1f2937;
    display: block;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .content-item-meta {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    margin-top: 0.375rem;
  }

  .content-type-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.625rem;
    border-radius: 6px;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .content-type-badge.video {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #b91c1c;
    border: 1px solid rgba(185, 28, 28, 0.2);
  }

  .content-type-badge.pdf {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1d4ed8;
    border: 1px solid rgba(29, 78, 216, 0.2);
  }

  .content-type-badge.quiz {
    background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
    color: #7c3aed;
    border: 1px solid rgba(124, 58, 237, 0.2);
  }

  .content-type-badge.homework {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #d97706;
    border: 1px solid rgba(217, 119, 6, 0.2);
  }

  .content-type-badge.reading {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #059669;
    border: 1px solid rgba(5, 150, 105, 0.2);
  }

  .content-type-badge.link {
    background: linear-gradient(135deg, #ccfbf1 0%, #99f6e4 100%);
    color: #0d9488;
    border: 1px solid rgba(13, 148, 136, 0.2);
  }

  .content-type-badge.zoom {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #2563eb;
    border: 1px solid rgba(37, 99, 235, 0.2);
  }

  .content-duration {
    font-size: 0.75rem;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    font-weight: 500;
  }

  .content-duration i {
    font-size: 0.7rem;
    color: #9ca3af;
  }

  .topic-no-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 2rem 1rem;
    color: #9ca3af;
    font-size: 0.85rem;
    background: linear-gradient(180deg, #fafafa 0%, #f5f5f5 100%);
    border-radius: 0 0 14px 14px;
  }

  .topic-no-content i {
    font-size: 1.5rem;
    opacity: 0.5;
  }

  /* Dark Theme Styles - Professional Modal Design */
  .dark-theme .content-preview-toggle {
    border-top-color: rgba(255, 255, 255, 0.1);
  }

  .dark-theme .btn-toggle-content {
    background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
    border-color: #374151;
  }

  .dark-theme .btn-toggle-content:hover {
    background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
    border-color: #B80101;
  }

  .dark-theme .btn-toggle-content.active {
    background: linear-gradient(135deg, #B80101 0%, #9a0101 100%);
    border-color: #B80101;
  }

  .dark-theme .toggle-content-info > i,
  .dark-theme .toggle-content-info > span {
    color: #e5e7eb;
  }

  .dark-theme .toggle-icon {
    color: #6b7280;
  }

  .dark-theme .content-count-badge {
    background: linear-gradient(135deg, #B80101 0%, #9a0101 100%);
  }

  /* Dark theme modal styles */
  .dark-theme .content-modal-drawer {
    background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
  }

  .dark-theme .drawer-body {
    background: #111827;
  }

  .dark-theme .drawer-body::-webkit-scrollbar-track {
    background: #1f2937;
  }

  .dark-theme .topic-preview-item {
    background: #1f2937;
    border-color: #374151;
  }

  .dark-theme .topic-preview-item:hover {
    border-color: #4b5563;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
  }

  .dark-theme .topic-preview-item.expanded {
    border-color: #B80101;
    box-shadow: 0 8px 32px rgba(184, 1, 1, 0.2);
  }

  .dark-theme .topic-preview-header:hover {
    background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
  }

  .dark-theme .topic-preview-item.expanded .topic-preview-header {
    background: linear-gradient(135deg, rgba(184, 1, 1, 0.15) 0%, rgba(184, 1, 1, 0.1) 100%);
  }

  .dark-theme .topic-title {
    color: #f3f4f6;
  }

  .dark-theme .topic-description {
    color: #9ca3af;
  }

  .dark-theme .topic-content-count,
  .dark-theme .topic-duration {
    background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
    color: #d1d5db;
    border-color: #4b5563;
  }

  .dark-theme .topic-toggle-icon {
    background: #374151;
    color: #9ca3af;
  }

  .dark-theme .topic-preview-item:hover .topic-toggle-icon {
    background: #4b5563;
    color: #e5e7eb;
  }

  .dark-theme .topic-content-items {
    background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
  }

  .dark-theme .content-item-preview {
    background: #111827;
    border-color: #374151;
  }

  .dark-theme .content-item-preview:hover {
    background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
    border-color: #B80101;
    transform: translateX(8px);
  }

  .dark-theme .content-item-title {
    color: #f3f4f6;
  }

  .dark-theme .content-duration {
    color: #9ca3af;
  }

  .dark-theme .topic-no-content {
    background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
    color: #6b7280;
  }

  /* Responsive Styles - Mobile First Professional Design */
  @media (max-width: 768px) {
    .content-modal-drawer {
      max-width: 100%;
    }

    .drawer-header-content {
      padding: 1rem;
    }

    .drawer-course-thumb {
      width: 50px;
      height: 50px;
    }

    .drawer-course-title {
      font-size: 1rem;
    }

    .drawer-close-btn {
      width: 40px;
      height: 40px;
    }

    .drawer-body {
      padding: 1rem;
    }

    .btn-toggle-content {
      padding: 0.625rem 0.875rem;
    }

    .toggle-content-info > span {
      font-size: 0.85rem;
    }

    .content-count-badge {
      min-width: 22px;
      height: 22px;
      font-size: 0.7rem;
    }

    .topic-preview-header {
      padding: 0.875rem 1rem;
    }

    .topic-number {
      width: 32px;
      height: 32px;
      min-width: 32px;
      font-size: 0.8rem;
    }

    .topic-title {
      font-size: 0.9rem;
    }

    .topic-meta {
      flex-wrap: wrap;
    }

    .topic-content-count,
    .topic-duration {
      font-size: 0.7rem;
      padding: 0.3rem 0.5rem;
    }

    .content-item-preview {
      padding: 0.75rem;
      gap: 0.75rem;
    }

    .content-item-icon {
      width: 38px;
      height: 38px;
      min-width: 38px;
    }

    .content-item-icon i {
      font-size: 1rem;
    }

    .content-item-title {
      font-size: 0.85rem;
    }
  }

  @media (max-width: 480px) {
    .drawer-course-info {
      gap: 0.75rem;
    }

    .drawer-course-thumb {
      width: 45px;
      height: 45px;
      border-radius: 10px;
    }

    .drawer-label {
      font-size: 0.65rem;
    }

    .drawer-course-title {
      font-size: 0.95rem;
      -webkit-line-clamp: 1;
    }

    .topic-info {
      gap: 0.75rem;
    }

    .topic-toggle-icon {
      width: 24px;
      height: 24px;
    }

    .content-item-preview:hover {
      transform: translateX(4px);
    }
  }
`;
  document.head.appendChild(style);

  // Cart Management System
  let cart = [];
  let cartTotal = 0;

  // Initialize cart from server
  function initCart() {
    // Initialize cart data from server
    window.sessionCart = window.cartData || [];
    console.log('Initializing cart with data:', window.sessionCart);

    // Update global cart count and refresh cart data
    if (window.globalCart) {
      window.globalCart.setSessionCart(window.sessionCart);
      window.globalCart.refreshCartData();
    }
  }

  // Add item to cart
  function addToCart(item) {
    // Check if user is logged in
    <% if (!user) { %>
    showCartNotification('Please login to add items to cart', 'error');
    setTimeout(() => {
      window.location.href = '/auth/login';
    }, 2000);
    return;
    <% } %>

    // Add to cart via API
    fetch('/purchase/cart/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          itemId: item.id,
          itemType: item.type || 'course',
          title: item.title,
          price: item.price,
          image: item.image
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showCartNotification(data.message, 'success');

          // Update global cart count and refresh cart data
          if (window.globalCart) {
            window.globalCart.refreshCartData();
          }

          // Show cart sidebar
          showCartSidebar();
        } else {
          showCartNotification(data.message || 'Failed to add item to cart', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showCartNotification('Network error. Please try again.', 'error');
      });
  }

  // Remove item from cart
  function removeFromCart(itemId) {
    // Ensure sessionCart is initialized
    if (!window.sessionCart) {
      window.sessionCart = [];
      showCartNotification('Cart is empty', 'error');
      return;
    }

    // Find the item in the session cart to get its type
    const item = window.sessionCart.find(cartItem => cartItem.id === itemId);
    if (!item) {
      showCartNotification('Item not found in cart', 'error');
      return;
    }

    console.log('Removing item from cart:', item);

    fetch('/purchase/cart/remove', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          itemId: itemId,
          itemType: item.type
        })
      })
      .then(response => {
        console.log('Response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Remove cart response:', data);
        if (data.success) {
          // Update session cart data
          window.sessionCart = window.sessionCart.filter(cartItem => cartItem.id !== itemId);
          showCartNotification('Item removed from cart');
          // Update global cart count and refresh cart data
          if (window.globalCart) {
            window.globalCart.updateCartSidebar();
          }
        } else {
          // Show detailed error message for ordering issues
          let errorMessage = data.message || 'Failed to remove item from cart';
          if (data.blockingCourse) {
            errorMessage = `${errorMessage} Cannot remove: "${data.blockingCourse.title}" (Order ${data.blockingCourse.order}) in your cart requires this course. Please remove courses in reverse order.`;
          }
          showCartNotification(errorMessage, 'error');
        }
      })
      .catch(error => {
        console.error('Error removing from cart:', error);
        showCartNotification('Error removing item from cart', 'error');
      });
  }

  // Update item quantity
  function updateQuantity(itemId, newQuantity) {
    const item = cart.find(item => item.id === itemId);
    if (item) {
      if (newQuantity <= 0) {
        removeFromCart(itemId);
      } else {
        item.quantity = newQuantity;
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartDisplay();
      }
    }
  }

  // Update cart display
  function updateCartDisplay() {
    updateCartCount();
    updateCartItems();
    updateCartTotal();
  }

  // Update cart count in header
  function updateCartCount() {
    const cartCount = document.getElementById('cartCount');
    if (cartCount) {
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      cartCount.textContent = totalItems;

      // Add animation class
      cartCount.classList.add('cart-count-updated');
      setTimeout(() => cartCount.classList.remove('cart-count-updated'), 300);
    }
  }

  // Update cart items in sidebar
  function updateCartItems() {
    const cartItems = document.getElementById('cartItems');
    if (!cartItems) return;

    if (cart.length === 0) {
      cartItems.innerHTML = `
      <div class="cart-empty">
        <div class="cart-empty-icon">
          <i class="fas fa-shopping-cart"></i>
        </div>
        <h4>Your cart is empty</h4>
        <p>Add some courses to get started!</p>
      </div>
    `;
      return;
    }

    cartItems.innerHTML = cart.map(item => `
    <div class="cart-item" data-id="${item.id}">
      <div class="cart-item-image">
        <img src="${item.image}" alt="${item.title}">
      </div>
      <div class="cart-item-details">
        <h5 class="cart-item-title">${item.title}</h5>
        <div class="cart-item-price">${item.price.toFixed(2)} EGP</div>
        <div class="cart-item-controls">
          <button class="cart-quantity-btn" onclick="updateQuantity('${item.id}', ${item.quantity - 1})">-</button>
          <span class="cart-quantity">${item.quantity}</span>
          <button class="cart-quantity-btn" onclick="updateQuantity('${item.id}', ${item.quantity + 1})">+</button>
        </div>
      </div>
      <div class="cart-item-actions">
        <button class="cart-remove-btn" onclick="removeFromCart('${item.id}')" title="Remove item">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  `).join('');
  }

  // Update cart total
  function updateCartTotal() {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const tax = 0; // No tax
    const total = subtotal + tax;

    const subtotalEl = document.querySelector('.cart-subtotal');
    const taxEl = document.querySelector('.cart-tax');
    const totalEl = document.querySelector('.cart-total-amount');

    if (subtotalEl) subtotalEl.textContent = `${subtotal.toFixed(2)} EGP`;
    if (taxEl) taxEl.textContent = `${tax.toFixed(2)} EGP`;
    if (totalEl) totalEl.textContent = `${total.toFixed(2)} EGP`;

    // Enable/disable checkout button
    const checkoutBtn = document.getElementById('cartCheckout');
    if (checkoutBtn) {
      checkoutBtn.disabled = cart.length === 0;
    }
  }

  // Show cart sidebar
  function showCartSidebar() {
    const cartSidebar = document.getElementById('cartSidebar');
    if (cartSidebar) {
      cartSidebar.classList.add('cart-sidebar-open');
      document.body.classList.add('cart-sidebar-active');
    }
  }

  // Hide cart sidebar
  function hideCartSidebar() {
    const cartSidebar = document.getElementById('cartSidebar');
    if (cartSidebar) {
      cartSidebar.classList.remove('cart-sidebar-open');
      document.body.classList.remove('cart-sidebar-active');
    }
  }

  // Proceed to checkout page
  function proceedToCheckout() {
    // Check if cart is empty
    if (!window.sessionCart || window.sessionCart.length === 0) {
      showCartNotification('Your cart is empty. Please add items before checkout.', 'error');
      return;
    }

    // Double-check with server cart data
    const cartCount = document.getElementById('cartCount');
    if (cartCount && parseInt(cartCount.textContent) === 0) {
      showCartNotification('Your cart is empty. Please add items before checkout.', 'error');
      return;
    }

    // Redirect to checkout page
    window.location.href = '/purchase/checkout';
  }

  // Show cart notification
  function showCartNotification(message, type = 'success') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `cart-notification cart-notification-${type}`;
    notification.innerHTML = `
    <div class="cart-notification-content">
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
      <span>${message}</span>
    </div>
  `;

    document.body.appendChild(notification);

    // Show notification
    setTimeout(() => notification.classList.add('show'), 100);

    // Calculate duration based on message length and type
    // Error messages, especially ordering errors, need more time to read
    let duration = 3000; // Default 3 seconds
    if (type === 'error') {
      // For error messages, calculate based on message length
      // Minimum 6 seconds, add 1 second per 50 characters
      duration = Math.max(6000, 6000 + (message.length / 50) * 1000);
      // Cap at 15 seconds for very long messages
      duration = Math.min(duration, 15000);
    } else if (type === 'success') {
      duration = 3000; // Success messages are shorter
    }

    // Hide notification
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => notification.remove(), 300);
    }, duration);
  }

  // Initialize cart on page load
  document.addEventListener('DOMContentLoaded', function() {
    initCart();

    // Cart toggle button
    const cartToggle = document.getElementById('cartToggle');
    const cartSidebar = document.getElementById('cartSidebar');
    const cartSidebarClose = document.getElementById('cartSidebarClose');
    const cartSidebarOverlay = document.getElementById('cartSidebarOverlay');
    const cartContinue = document.getElementById('cartContinue');
    const cartCheckout = document.getElementById('cartCheckout');

    // Open cart sidebar
    if (cartToggle) {
      cartToggle.addEventListener('click', showCartSidebar);
    }

    // Close cart sidebar
    if (cartSidebarClose) {
      cartSidebarClose.addEventListener('click', hideCartSidebar);
    }
    if (cartSidebarOverlay) {
      cartSidebarOverlay.addEventListener('click', hideCartSidebar);
    }
    if (cartContinue) {
      cartContinue.addEventListener('click', hideCartSidebar);
    }

    // Checkout button
    if (cartCheckout) {
      cartCheckout.addEventListener('click', function() {
        proceedToCheckout();
      });
    }

    // Close cart on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && cartSidebar && cartSidebar.classList.contains('cart-sidebar-open')) {
        hideCartSidebar();
      }
    });
  });

  // Toggle wishlist function
  function toggleWishlist(itemId, itemType) {
    // Check if user is logged in
    <% if (!user) { %>
    showCartNotification('Please login to manage your wishlist', 'error');
    setTimeout(() => {
      window.location.href = '/auth/login';
    }, 3500); // Increased delay
    return;
    <% } %>

    // Find the heart icon - use event target for more reliable selection
    const heartIcon = event.target.closest('.course-favorite-btn-enhanced, .bundle-wishlist-btn').querySelector('i');
    const isCurrentlyInWishlist = heartIcon.classList.contains('fas');

    console.log('Toggling wishlist for:', itemId, itemType, 'Currently in wishlist:', isCurrentlyInWishlist);

    // Show loading state
    heartIcon.classList.add('fa-spinner', 'fa-spin');
    heartIcon.classList.remove('fas', 'far');

    // Toggle wishlist via API
    fetch('/purchase/wishlist/toggle', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          itemId: itemId,
          itemType: itemType
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log('Wishlist toggle response:', data);

        if (data.success) {
          // Update heart icon based on new status
          heartIcon.classList.remove('fa-spinner', 'fa-spin');
          if (data.isInWishlist) {
            heartIcon.classList.add('fas');
            heartIcon.classList.remove('far');
            heartIcon.style.color = '#ff6b6b';
          } else {
            heartIcon.classList.add('far');
            heartIcon.classList.remove('fas');
            heartIcon.style.color = '';
          }

          showCartNotification(data.message, 'success');
        } else {
          // Revert to original state
          heartIcon.classList.remove('fa-spinner', 'fa-spin');
          if (isCurrentlyInWishlist) {
            heartIcon.classList.add('fas');
            heartIcon.classList.remove('far');
            heartIcon.style.color = '#ff6b6b';
          } else {
            heartIcon.classList.add('far');
            heartIcon.classList.remove('fas');
            heartIcon.style.color = '';
          }

          showCartNotification(data.message || 'Failed to add item to cart', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        // Revert to original state
        heartIcon.classList.remove('fa-spinner', 'fa-spin');
        if (isCurrentlyInWishlist) {
          heartIcon.classList.add('fas');
          heartIcon.classList.remove('far');
          heartIcon.style.color = '#ff6b6b';
        } else {
          heartIcon.classList.add('far');
          heartIcon.classList.remove('fas');
          heartIcon.style.color = '';
        }

        showCartNotification('Error updating wishlist', 'error');
      });
  }
</script>

<!-- Shopping Cart Sidebar -->
<div class="cart-sidebar" id="cartSidebar">
  <div class="cart-sidebar-overlay" id="cartSidebarOverlay"></div>
  <div class="cart-sidebar-content">
    <div class="cart-sidebar-header">
      <h3 class="cart-sidebar-title">
        <i class="fas fa-shopping-cart"></i>
        Shopping Cart
      </h3>
      <button class="cart-sidebar-close" id="cartSidebarClose">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="cart-sidebar-body">
      <div class="cart-items" id="cartItems">
        <div class="cart-empty">
          <div class="cart-empty-icon">
            <i class="fas fa-shopping-cart"></i>
          </div>
          <h4>Your cart is empty</h4>
          <p>Add some courses to get started!</p>
        </div>
      </div>
    </div>

    <div class="cart-sidebar-footer">
      <div class="cart-total" id="cartTotal">
        <div class="cart-total-row">
          <span>Subtotal:</span>
          <span class="cart-subtotal">0.00 EGP</span>
        </div>
        <div class="cart-total-row cart-total-final">
          <span>Total:</span>
          <span class="cart-total-amount">0.00 EGP</span>
        </div>
      </div>

      <div class="cart-actions">
        <button class="btn-cart-checkout" id="cartCheckout" disabled>
          <i class="fas fa-credit-card"></i>
          Proceed to Checkout
        </button>
        <button class="btn-cart-continue" id="cartContinue">
          Continue Shopping
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Import CSS -->
<link rel="stylesheet" href="/css/index.css">


<style>
  .btn-purchased-enhanced,
  .btn-purchased {
    background: #27ae60 !important;
    color: white !important;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: not-allowed;
    opacity: 0.8;
    text-decoration: none;
  }

  .btn-access-courses {
    background: #3498db !important;
    color: white !important;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .btn-access-courses:hover {
    background: #2980b9 !important;
    color: white !important;
    text-decoration: none;
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(52, 152, 219, 0.3);
  }

  .quick-action-btn.purchased {
    background: #27ae60 !important;
    color: white !important;
    cursor: not-allowed;
    opacity: 0.8;
  }

  .notification {
    position: fixed;
    top: 2rem;
    right: 2rem;
    background: white;
    border-radius: 10px;
    padding: 1rem 1.5rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    transform: translateX(100%);
    opacity: 0;
    transition: all 0.3s ease;
  }

  .notification.show {
    transform: translateX(0);
    opacity: 1;
  }

  .notification-success {
    border-left: 4px solid #27ae60;
  }

  .notification-error {
    border-left: 4px solid #e74c3c;
  }

  .notification-content {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .notification-success .notification-content i {
    color: #27ae60;
  }

  .notification-error .notification-content i {
    color: #e74c3c;
  }

  /* Cart notification styles */
  .cart-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 12px;
    padding: 1.25rem 1.75rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
    z-index: 9999;
    opacity: 0;
    transition: all 0.3s ease;
    max-width: 500px;
    min-width: 300px;
    word-wrap: break-word;
  }

  .cart-notification.show {
    transform: translate(-50%, -50%);
    opacity: 1;
  }

  .cart-notification-success {
    border-left: 5px solid #27ae60;
    background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
  }

  .cart-notification-error {
    border-left: 5px solid #e74c3c;
    background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);
  }

  .cart-notification-content {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
  }

  .cart-notification-content i {
    font-size: 1.5rem;
    flex-shrink: 0;
    margin-top: 0.1rem;
  }

  .cart-notification-content span {
    font-size: 1rem;
    line-height: 1.5;
    color: #1f2937;
    font-weight: 500;
  }

  .cart-notification-success .cart-notification-content i {
    color: #27ae60;
  }

  .cart-notification-error .cart-notification-content i {
    color: #e74c3c;
  }

  .cart-notification-error .cart-notification-content span {
    color: #991b1b;
    font-weight: 600;
  }

  /* Bundle wishlist button styles */
  .bundle-title-container {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .bundle-wishlist-btn {
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 50%;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
  }

  .bundle-wishlist-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.4);
    transform: scale(1.1);
  }

  .bundle-wishlist-btn i {
    font-size: 1.2rem;
    transition: all 0.3s ease;
  }

  .bundle-wishlist-btn:hover i {
    transform: scale(1.1);
  }

  /* Fix course and bundle image display */
  .course-card-media-enhanced {
    position: relative;
    height: 240px;
    width: 100%;
    overflow: hidden;
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .course-card-media-enhanced img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center center;
    transition: all 0.4s ease;
    display: block;
  }

  /* Card positioning - modal approach no longer needs visible overflow */
  .course-card-enhanced {
    position: relative;
    overflow: hidden;
    border-radius: 16px;
    transition: all 0.3s ease;
  }

  .course-card-enhanced:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
  }

  /* Keep overflow hidden on media section only */
  .course-card-media-enhanced {
    overflow: hidden;
  }

  /* Bundle header image if any */
  .bundle-header-info img,
  .bundle-purchase-card img {
    max-width: 100%;
    height: auto;
    object-fit: contain;
    object-position: center;
  }

  /* Fully Booked Button Enhanced Styles */
  .btn-fully-booked-enhanced {
    background: linear-gradient(135deg, #dc3545, #c82333) !important;
    color: white !important;
    width: 100%;
    padding: 14px 20px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: not-allowed;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .btn-fully-booked-enhanced::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
  }

  .btn-fully-booked-enhanced:hover::before {
    left: 100%;
  }

  .fully-booked-text {
    font-size: 15px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  /* Responsive image fixes */
  @media (max-width: 768px) {
    .course-card-media-enhanced {
      height: 200px;
    }
  }

  @media (max-width: 576px) {
    .course-card-media-enhanced {
      height: 180px;
    }
  }
</style>

<!-- Import JavaScript -->
<script src="/js/index.js"></script>
<script src="/js/enhanced-scroll-effects.js"></script>

<%- include('partials/footer') %>