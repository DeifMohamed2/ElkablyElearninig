<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= quiz.title %> - Taking Quiz | ELKABLY</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/images/KImage.png">
    <link rel="shortcut icon" type="image/png" href="/images/KImage.png">
    <link rel="apple-touch-icon" href="/images/KImage.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/css/studentCSS/student-main.css">
    <link rel="stylesheet" href="/css/studentCSS/quizzes.css">
    <link rel="stylesheet" href="/css/theme-toggle.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- MathLive for professional math input -->
    <script src="https://unpkg.com/mathlive"></script>
    
    <!-- Enhanced Professional Styles -->
    <style>
        /* Full Page Layout */
        .quiz-full-page-layout {
            min-height: 100vh;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            display: flex;
            flex-direction: column;
        }

        /* Quiz Page Header */
        .quiz-page-header {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(220, 38, 38, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .quiz-header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .quiz-header-info {
            flex: 1;
        }

        .quiz-page-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0 0 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .quiz-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .quiz-type, .quiz-difficulty {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        /* Main Content */
        .quiz-main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Quiz Taking Container */
        .quiz-taking-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: calc(100vh - 200px);
        }

        /* Compact Professional Quiz Header */
        .quiz-header {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            padding: 1.5rem 2rem;
            position: relative;
            overflow: hidden;
        }

        .quiz-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .quiz-header-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            position: relative;
            z-index: 1;
            width: 100%;
        }

        .quiz-timer-section {
            flex-shrink: 0;
        }

        .quiz-progress-section {
            flex-shrink: 0;
        }

        .quiz-timer {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.2));
            padding: 0.875rem 1.5rem;
            border-radius: 14px;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(59, 130, 246, 0.3);
            min-width: 180px;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .quiz-timer:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        .timer-icon-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.4));
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .timer-icon {
            font-size: 1.2rem;
            color: #3b82f6;
        }

        .timer-content {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            flex: 1;
        }

        .timer-label {
            font-size: 0.7rem;
            opacity: 0.9;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.9);
        }

        .timer-text {
            font-size: 1.3rem;
            font-weight: 800;
            line-height: 1;
            color: #ffffff;
            font-family: 'Inter', monospace;
            letter-spacing: 1px;
        }

        .timer-warning .timer-icon-wrapper {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.4));
            border-color: rgba(251, 191, 36, 0.5);
        }

        .timer-warning .timer-icon {
            color: #fbbf24;
        }

        .timer-warning {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.2)) !important;
            border-color: rgba(251, 191, 36, 0.3) !important;
        }

        .timer-danger .timer-icon-wrapper {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.4));
            border-color: rgba(239, 68, 68, 0.5);
            animation: pulse-icon 1.5s infinite;
        }

        .timer-danger .timer-icon {
            color: #ef4444;
        }

        .timer-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.2)) !important;
            border-color: rgba(239, 68, 68, 0.3) !important;
            animation: pulse-danger 1.5s infinite;
        }
        
        .quiz-timer.no-time-limit {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.2));
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .quiz-timer.no-time-limit .timer-icon-wrapper {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.4));
            border-color: rgba(16, 185, 129, 0.5);
        }

        .quiz-timer.no-time-limit .timer-icon {
            color: #10b981;
        }

        @keyframes pulse-danger {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }

        @keyframes pulse-icon {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }

        /* Compact Progress Section */
        .quiz-progress-section {
            position: relative;
            z-index: 1;
            flex-shrink: 0;
            margin-left: auto;
        }

        .progress-info {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 600;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .question-counter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .current-question {
            font-size: 1.1rem;
            font-weight: 800;
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.15);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .separator {
            opacity: 0.7;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .total-questions {
            opacity: 0.8;
            font-size: 1rem;
            font-weight: 600;
        }

        .progress-percentage {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.15);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .progress-bar-container {
            position: relative;
            display: flex;
            justify-content: flex-end;
        }

        .progress-bar {
            width: 200px;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            border-radius: 3px;
            transition: width 0.4s ease;
            box-shadow: 0 1px 4px rgba(251, 191, 36, 0.4);
        }

        /* Main Quiz Content */
        .quiz-content-full {
            padding: 0;
        }

        /* Enhanced Question Section */
        .question-section-enhanced {
            padding: 3rem;
            background: white;
        }

        .question-header-enhanced {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #f1f5f9;
        }

        .question-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .question-number {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .question-points {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .question-content {
            margin-bottom: 2rem;
        }

        .question-text {
            font-size: 1.3rem;
            font-weight: 500;
            line-height: 1.7;
            margin-bottom: 2rem;
            color: #1e293b;
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid #dc2626;
        }

        /* Question Image Container */
        .question-image-container {
            position: relative;
            margin: 1.5rem 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .question-image-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .question-image {
            width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: contain;
            display: block;
        }

        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            color: white;
            font-weight: 600;
        }

        .question-image-container:hover .image-overlay {
            opacity: 1;
        }

        .image-overlay i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .image-overlay span {
            font-size: 0.9rem;
        }

        /* Enhanced Options */
        .options-container {
            margin-bottom: 2rem;
        }

        .option-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem 2rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .option-item:hover {
            border-color: #dc2626;
            background: rgba(220, 38, 38, 0.02);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.1);
        }

        .option-item.selected {
            border-color: #dc2626;
            background: rgba(220, 38, 38, 0.05);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.2);
        }

        .option-radio {
            width: 24px;
            height: 24px;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .option-item.selected .option-radio {
            border-color: #dc2626;
            background: #dc2626;
        }

        .option-item.selected .option-radio::after {
            content: '';
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
        }

        .option-text {
            flex: 1;
            font-size: 1.1rem;
            line-height: 1.6;
            color: #1e293b;
            font-weight: 500;
        }

        .option-image {
            max-width: 100px;
            height: auto;
            border-radius: 6px;
            margin-left: auto;
        }

        /* Enhanced Navigation */
        .quiz-navigation-enhanced {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 2px solid #f1f5f9;
        }

        .navigation-center {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .questions-mini-nav {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .mini-nav-item {
            width: 45px;
            height: 45px;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
            font-size: 1rem;
            background: white;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .mini-nav-item:hover {
            border-color: #dc2626;
            background: rgba(220, 38, 38, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);
        }

        .mini-nav-item.current {
            border-color: #dc2626;
            background: #dc2626;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
        }

        .mini-nav-item.answered {
            border-color: #10b981;
            background: #10b981;
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .mini-nav-item.answered::after {
            content: 'âœ“';
            position: absolute;
            top: -5px;
            right: -5px;
            background: #059669;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            border: 2px solid white;
        }

        .mini-nav-item.answered.current {
            border-color: #10b981;
            background: #10b981;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .mini-nav-item.not-answered {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
            color: #d97706;
        }

        /* Enhanced Navigation Buttons */
        .nav-button {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
            background: linear-gradient(135deg, #b91c1c, #991b1b);
            color: white;
        }

        .nav-button:disabled {
            background: #94a3b8;
            color: white;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .nav-button.secondary {
            background: white;
            color: #64748b;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .nav-button.secondary:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-color: #dc2626;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.3);
        }

        /* Enhanced Bottom Bar */
        .quiz-bottom-bar {
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            padding: 1.5rem 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .quiz-summary-enhanced {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .summary-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }

        .summary-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e293b;
        }

        .btn-submit-enhanced {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-submit-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-submit-enhanced:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Written Question Styles */
        .written-question-container {
            margin-top: 1rem;
        }

        .written-question-note {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            border-left: 4px solid #dc2626;
        }

        .note-icon {
            color: #dc2626;
            font-size: 1.1rem;
            margin-top: 0.1rem;
            flex-shrink: 0;
        }

        .note-content {
            flex: 1;
            font-size: 0.95rem;
            line-height: 1.5;
            color: #1e293b;
        }

        .note-content code {
            background: rgba(220, 38, 38, 0.1);
            color: #dc2626;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            font-weight: 600;
        }

        .written-answer-input {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            color: #1e293b;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .written-answer-input:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        /* Dark Theme Support */
        .dark-theme .quiz-full-page-layout {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        .dark-theme .quiz-taking-container {
            background: #1e293b;
            border: 1px solid #334155;
        }

        .dark-theme .question-section-enhanced {
            background: #1e293b;
        }

        .dark-theme .question-header-enhanced {
            border-bottom-color: #334155;
        }

        .dark-theme .question-text {
            background: #334155;
            color: #f1f5f9;
            border-left-color: #dc2626;
        }

        .dark-theme .option-item {
            background: #334155;
            border-color: #475569;
        }

        .dark-theme .option-item:hover {
            background: rgba(220, 38, 38, 0.1);
        }

        .dark-theme .option-item.selected {
            background: rgba(220, 38, 38, 0.15);
        }

        .dark-theme .option-text {
            color: #f1f5f9;
        }

        .dark-theme .nav-button.secondary {
            background: #334155;
            color: #cbd5e1;
            border-color: #475569;
        }

        .dark-theme .nav-button.secondary:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-color: #dc2626;
            color: white;
        }

        .dark-theme .mini-nav-item {
            background: #334155;
            border-color: #475569;
            color: #cbd5e1;
        }

        .dark-theme .quiz-bottom-bar {
            background: #334155;
            border-top-color: #475569;
        }

        .dark-theme .summary-label {
            color: #94a3b8;
        }

        .dark-theme .summary-value {
            color: #f1f5f9;
        }

        .dark-theme .quiz-navigation-enhanced {
            border-top-color: #334155;
        }

        .dark-theme .written-question-note {
            background: #1e293b;
            border-color: #475569;
        }

        .dark-theme .note-content {
            color: #f1f5f9;
        }

        .dark-theme .written-answer-input {
            background: #334155;
            border-color: #475569;
            color: #f1f5f9;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .quiz-header-container {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .quiz-page-title {
                font-size: 1.5rem;
            }

            .quiz-main-content {
                padding: 1rem;
            }

            .question-section-enhanced {
                padding: 2rem;
            }

            .mini-nav-item {
                width: 35px;
                height: 35px;
                font-size: 0.8rem;
            }

            .quiz-header-compact {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
        }

        @media (max-width: 768px) {
            .quiz-page-header {
                padding: 1rem;
            }

            .quiz-page-title {
                font-size: 1.3rem;
            }

            .quiz-main-content {
                padding: 0.5rem;
            }

            .quiz-header {
                padding: 1rem;
            }

            .question-section-enhanced {
                padding: 1.5rem;
            }

            .question-header-enhanced {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .question-info {
                justify-content: center;
            }

            .question-text {
                font-size: 1.1rem;
                padding: 1rem;
            }

            .option-item {
                padding: 1rem 1.5rem;
            }

            .quiz-navigation-enhanced {
                flex-direction: column;
                gap: 1.5rem;
            }

            .nav-button {
                width: 100%;
                justify-content: center;
            }

            .questions-mini-nav {
                order: -1;
            }

            .mini-nav-item {
                width: 32px;
                height: 32px;
                font-size: 0.75rem;
            }

            .quiz-bottom-bar {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem 1.5rem;
            }

            .btn-submit-enhanced {
                width: 100%;
                justify-content: center;
            }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success { border-left: 4px solid #10b981; }
        .toast.info { border-left: 4px solid #3b82f6; }
        .toast.error { border-left: 4px solid #ef4444; }

        .toast-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .toast-icon { font-size: 1.2rem; }
        .toast.success .toast-icon { color: #10b981; }
        .toast.info .toast-icon { color: #3b82f6; }
        .toast.error .toast-icon { color: #ef4444; }

        .toast-title {
            font-weight: 600;
            color: #1f2937;
        }

        .toast-message {
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Image Preview Modal */
        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 2rem;
        }

        .image-preview-modal.show {
            display: flex;
        }

        .image-preview-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .image-preview-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }

        .image-preview-close {
            position: absolute;
            top: -50px;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
    </style>
    
    <meta name="theme-color" content="#dc2626">
</head>
<body class="<%= theme %>-theme">
    <!-- Full Page Quiz Layout -->
    <div class="quiz-full-page-layout">
        <!-- Quiz Header with Back Button -->
        <header class="quiz-page-header">
            <div class="quiz-header-container">
                <button class="back-button" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Quiz Details</span>
                </button>
                <div class="quiz-header-info">
                    <h1 class="quiz-page-title">
                        <i class="fas fa-question-circle"></i>
                        <%= quiz.title %>
                    </h1>
                    <div class="quiz-meta">
                        <span class="quiz-type">Guest Quiz</span>
                        <span class="quiz-difficulty"><%= quiz.difficulty || 'Medium' %></span>
                    </div>
                </div>
            </div>
        </header>
            
        <!-- Quiz Taking Content -->
        <main class="quiz-main-content">
            <div class="quiz-taking-container">
                <!-- Quiz Header -->
                <div class="quiz-header">
                    <div class="quiz-header-compact">
                        <div class="quiz-timer-section">
                            <% if (timing && timing.durationMinutes > 0) { %>
                                <div class="quiz-timer" id="quizTimer">
                                    <div class="timer-icon-wrapper">
                                        <i class="fas fa-clock timer-icon"></i>
                                    </div>
                                    <div class="timer-content">
                                        <span class="timer-label">Time Remaining</span>
                                        <span class="timer-text" id="timerText">00:00</span>
                                    </div>
                                </div>
                            <% } else { %>
                                <div class="quiz-timer no-time-limit" id="quizTimer">
                                    <div class="timer-icon-wrapper">
                                        <i class="fas fa-infinity timer-icon"></i>
                                    </div>
                                    <div class="timer-content">
                                        <span class="timer-label">Time Limit</span>
                                        <span class="timer-text" id="timerText">No Time Limit</span>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                        
                        <div class="quiz-progress-section">
                            <div class="progress-info">
                                <span class="question-counter">
                                    <span class="current-question" id="currentQuestionNumber">1</span>
                                    <span class="separator">of</span>
                                    <span class="total-questions" id="totalQuestions"><%= quiz.selectedQuestions ? quiz.selectedQuestions.length : 0 %></span>
                                </span>
                                <span class="progress-percentage" id="progressPercentage">0%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Quiz Content -->
                <div class="quiz-content-full">
                    <div class="question-section-enhanced">
                        <div class="question-header-enhanced">
                            <div class="question-info">
                                <div class="question-number" id="questionNumber">Question 1</div>
                                <div class="question-points" id="questionPoints">1 point</div>
                            </div>
                        </div>
                        
                        <div class="question-content">
                            <div class="question-text" id="questionText">Loading question...</div>
                            
                            <div class="question-image-container" id="questionImageContainer" style="display: none;" onclick="previewImage(document.getElementById('questionImage').src);">
                                <img class="question-image" id="questionImage" alt="Question Image">
                                <div class="image-overlay">
                                    <i class="fas fa-search-plus"></i>
                                    <span>Click to preview</span>
                                </div>
                            </div>
                            
                            <div class="options-container" id="optionsContainer" style="display: none;"></div>

                            <div class="written-question-container" id="writtenQuestionContainer" style="display: none;">
                                <div class="written-question-note">
                                    <div class="note-icon"><i class="fas fa-info-circle"></i></div>
                                    <div class="note-content">
                                        <strong>Note:</strong> If you think there are two answers, type them like this: <code>10,-10</code>
                                    </div>
                                </div>
                                <textarea class="written-answer-input" id="writtenAnswerInput" placeholder="Enter your answer here..." oninput="handleWrittenAnswer()"></textarea>
                            </div>
                        </div>
                        
                        <div class="quiz-navigation-enhanced">
                            <button class="nav-button secondary" id="prevButton" onclick="previousQuestion()" disabled>
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <div class="navigation-center">
                                <div class="questions-mini-nav" id="questionsMiniNav"></div>
                            </div>
                            <button class="nav-button" id="nextButton" onclick="nextQuestion()">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="quiz-bottom-bar">
                        <div class="quiz-summary-enhanced">
                            <div class="summary-item">
                                <span class="summary-label">Answered:</span>
                                <span class="summary-value" id="summaryAnswered">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Remaining:</span>
                                <span class="summary-value" id="summaryRemaining">0</span>
                            </div>
                            <% if (timing && timing.durationMinutes > 0) { %>
                                <div class="summary-item">
                                    <span class="summary-label">Time Left:</span>
                                    <span class="summary-value" id="summaryTimeLeft">00:00</span>
                                </div>
                            <% } %>
                        </div>
                        <button class="btn-submit-enhanced" id="submitButton" onclick="submitQuiz()" disabled>
                            <i class="fas fa-check"></i> Submit Quiz
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Image Preview Modal -->
    <div id="imagePreviewModal" class="image-preview-modal" onclick="closeImagePreview()">
        <div class="image-preview-content" onclick="event.stopPropagation()">
            <button class="image-preview-close" onclick="closeImagePreview()"><i class="fas fa-times"></i></button>
            <img id="previewImage" src="" alt="Preview">
        </div>
    </div>

    <!-- Hidden meta for quiz timing -->
    <div id="quizMeta"
         data-timing="<%- encodeURIComponent(JSON.stringify(timing || {})) %>"
         data-attempt-number="<%= attemptNumber || 1 %>"
         data-guest-id="<%= guestUser._id %>"></div>

    <script>
        // Parse math expressions
        function parseMathExpressions(text) {
            if (!text) return '';
            const mathPattern = /\$([^$]+)\$/g;
            const parts = [];
            let lastIndex = 0;
            let match;
            let mathIndex = 0;
            
            while ((match = mathPattern.exec(text)) !== null) {
                if (match.index > lastIndex) {
                    parts.push({ type: 'text', content: text.substring(lastIndex, match.index) });
                }
                parts.push({ type: 'math', content: match[1], index: mathIndex++ });
                lastIndex = match.index + match[0].length;
            }
            
            if (lastIndex < text.length) {
                parts.push({ type: 'text', content: text.substring(lastIndex) });
            }
            
            if (parts.length === 0) return formatTextFormatting(text);
            
            let html = '';
            parts.forEach(part => {
                if (part.type === 'text') {
                    html += formatTextFormatting(part.content);
                } else {
                    const mathId = `math-field-${Date.now()}-${Math.random()}-${part.index}`;
                    html += `<math-field id="${mathId}" readonly style="display: inline-block; min-height: 24px; font-size: 16px; border: none; background: transparent; padding: 2px 4px; vertical-align: middle; color: inherit;" class="preview-math-field">${escapeHtml(part.content)}</math-field>`;
                }
            });
            return html;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTextFormatting(text) {
            if (!text) return '';
            function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
            let result = '';
            const re = /#\*([\s\S]*?)\*#|\*\*([\s\S]*?)\*\*/g;
            let m; let lastIdx = 0;
            while ((m = re.exec(text)) !== null) {
                result += esc(text.substring(lastIdx, m.index));
                if (m[1] !== undefined) result += '<u>' + esc(m[1]) + '</u>';
                else result += '<b>' + esc(m[2]) + '</b>';
                lastIdx = re.lastIndex;
            }
            result += esc(text.substring(lastIdx));
            return result;
        }

        function initializeMathFields() {
            if (typeof MathLive === 'undefined') {
                setTimeout(initializeMathFields, 100);
                return;
            }
            const isDarkMode = document.body.classList.contains('dark-theme');
            const mathFields = document.querySelectorAll('math-field');
            mathFields.forEach((field) => {
                if (isDarkMode) {
                    field.style.color = '#f1f5f9';
                }
            });
        }

        // Quiz data
        const quizData = {
            quizId: '<%= quiz._id %>',
            questions: [],
            settings: {},
            attemptNumber: 1,
            remainingSeconds: 0,
            isExpired: false,
            totalQuestions: 0
        };

        // Load server meta
        (function loadServerMeta(){
            var metaEl = document.getElementById('quizMeta');
            try {
                var timingStr = metaEl ? metaEl.getAttribute('data-timing') : '';
                var attemptStr = metaEl ? metaEl.getAttribute('data-attempt-number') : '';
                var serverTiming = timingStr ? JSON.parse(decodeURIComponent(timingStr)) : {};
                quizData.settings.duration = serverTiming.durationMinutes || 0;
                quizData.settings.passingScore = serverTiming.passingScore || 60;
                quizData.attemptNumber = attemptStr ? parseInt(attemptStr) : 1;
                quizData.remainingSeconds = serverTiming.remainingSeconds || 0;
                quizData.isExpired = !!serverTiming.isExpired;
                if (quizData.isExpired) clearSavedState();
            } catch (e) {
                console.error('Failed to parse server meta:', e);
            }
        })();

        const guestId = document.getElementById('quizMeta')?.getAttribute('data-guest-id') || 'guest';
        const quizCacheKey = `guestQuizAnswers:${guestId}:<%= quiz._id %>`;
        
        function loadSavedState() {
            try {
                const raw = localStorage.getItem(quizCacheKey);
                if (!raw) return;
                const data = JSON.parse(raw);
                if (!data || data.attemptNumber !== quizData.attemptNumber) {
                    clearSavedState();
                    return;
                }
                if (data.answers) answers = data.answers;
                if (typeof data.currentQuestionIndex === 'number') {
                    currentQuestionIndex = Math.max(0, data.currentQuestionIndex);
                }
            } catch (e) {
                clearSavedState();
            }
        }
        
        function saveState() {
            try {
                localStorage.setItem(quizCacheKey, JSON.stringify({
                    attemptNumber: quizData.attemptNumber,
                    answers: answers,
                    currentQuestionIndex: currentQuestionIndex,
                    savedAt: Date.now()
                }));
            } catch (e) {}
        }
        
        function clearSavedState() {
            try { localStorage.removeItem(quizCacheKey); } catch (e) {}
        }

        let currentQuestionIndex = 0;
        let answers = {};
        let timeRemaining = 0;
        let timerInterval = null;
        let quizStarted = false;

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const hasExistingState = localStorage.getItem(quizCacheKey);
                if (!hasExistingState && quizData.attemptNumber === 1) {
                    answers = {};
                    currentQuestionIndex = 0;
                    clearSavedState();
                } else {
                    loadSavedState();
                }
                
                initializeSecureQuiz();
                
                if (quizData.settings.duration > 0) {
                    timeRemaining = quizData.remainingSeconds > 0 ? quizData.remainingSeconds : quizData.settings.duration * 60;
                    if (quizData.isExpired || timeRemaining <= 0) {
                        submitQuiz(true);
                    } else {
                        startTimer();
                    }
                }
            }, 100);
        });

        function initializeSecureQuiz() {
            loadAllSecureQuestions();
            quizStarted = true;
        }

        function loadAllSecureQuestions() {
            document.getElementById('questionText').textContent = 'Loading questions...';
            document.getElementById('optionsContainer').style.display = 'none';
            document.getElementById('writtenQuestionContainer').style.display = 'none';
            
            fetch('/guest/quiz/secure-questions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quizId: quizData.quizId, attemptNumber: quizData.attemptNumber })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    quizData.questions = data.questions;
                    quizData.totalQuestions = data.totalQuestions;
                    document.getElementById('totalQuestions').textContent = quizData.totalQuestions;
                    currentQuestionIndex = Math.min(Math.max(0, currentQuestionIndex), quizData.totalQuestions - 1);
                    loadQuestion(currentQuestionIndex);
                    updateProgress();
                    updateQuizSummary();
                    generateQuestionNavigation();
                    updateQuestionNavigation();
                    checkSubmitButton();
                } else {
                    showToast('Error loading questions: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error loading questions:', error);
                showToast('Error loading questions. Please try again.', 'error');
            });
        }

        function loadQuestion(index) {
            if (index < 0 || index >= quizData.questions.length) return;
            currentQuestionIndex = index;
            updateQuestionDisplay();
            updateProgress();
            updateQuestionNavigation();
        }

        function updateQuestionDisplay() {
            const question = quizData.questions[currentQuestionIndex];
            if (!question) return;
            
            document.getElementById('questionNumber').textContent = `Question ${currentQuestionIndex + 1}`;
            document.getElementById('questionPoints').textContent = `${question.points || 1} point${(question.points || 1) > 1 ? 's' : ''}`;
            document.getElementById('currentQuestionNumber').textContent = currentQuestionIndex + 1;
            document.getElementById('questionText').innerHTML = parseMathExpressions(question.questionText || '');
            
            const questionImageContainer = document.getElementById('questionImageContainer');
            const questionImage = document.getElementById('questionImage');
            if (question.questionImage && question.questionImage.trim()) {
                questionImage.src = question.questionImage;
                questionImageContainer.style.display = 'block';
            } else {
                questionImageContainer.style.display = 'none';
            }
            
            const optionsContainer = document.getElementById('optionsContainer');
            const writtenContainer = document.getElementById('writtenQuestionContainer');
            if (question.questionType === 'Written') {
                optionsContainer.style.display = 'none';
                writtenContainer.style.display = 'block';
                loadWrittenQuestion();
            } else {
                optionsContainer.style.display = 'block';
                writtenContainer.style.display = 'none';
                loadOptions();
            }
            
            updateNavigationButtons();
            setTimeout(initializeMathFields, 100);
        }

        function loadOptions() {
            const question = quizData.questions[currentQuestionIndex];
            if (!question) return;
            
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            if (!question.options || !question.options.length) {
                container.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 2rem;">No options available.</p>';
                return;
            }
            
            const questionId = question._id;
            const savedAnswer = answers[questionId];
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option-item';
                optionElement.onclick = () => selectOption(index);
                
                const isSelected = savedAnswer === option.text || savedAnswer === index.toString();
                if (isSelected) optionElement.classList.add('selected');

                optionElement.innerHTML = `
                    <div class="option-radio"></div>
                    <div class="option-text">${parseMathExpressions(option.text || '')}</div>
                    ${option.image && option.image.trim() ? `<img src="${option.image}" alt="Option image" class="option-image">` : ''}
                `;
                container.appendChild(optionElement);
            });
        }

        function loadWrittenQuestion() {
            const question = quizData.questions[currentQuestionIndex];
            if (!question) return;
            const textInput = document.getElementById('writtenAnswerInput');
            textInput.value = answers[question._id] || '';
        }

        function handleWrittenAnswer() {
            const question = quizData.questions[currentQuestionIndex];
            if (!question) return;
            answers[question._id] = document.getElementById('writtenAnswerInput').value.trim();
            saveState();
            updateQuizSummary();
            checkSubmitButton();
            updateQuestionNavigation();
        }

        function selectOption(optionIndex) {
            const question = quizData.questions[currentQuestionIndex];
            if (!question) return;
            
            document.querySelectorAll('.option-item').forEach(item => item.classList.remove('selected'));
            document.querySelectorAll('.option-item')[optionIndex].classList.add('selected');
            
            answers[question._id] = question.options[optionIndex].text;
            saveState();
            updateQuizSummary();
            checkSubmitButton();
            updateQuestionNavigation();
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
                saveState();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < quizData.questions.length - 1) {
                loadQuestion(currentQuestionIndex + 1);
                saveState();
            }
        }

        function updateNavigationButtons() {
            document.getElementById('prevButton').disabled = currentQuestionIndex === 0;
            document.getElementById('nextButton').style.display = currentQuestionIndex === quizData.questions.length - 1 ? 'none' : 'flex';
        }

        function generateQuestionNavigation() {
            const miniNav = document.getElementById('questionsMiniNav');
            miniNav.innerHTML = '';
            for (let i = 0; i < quizData.totalQuestions; i++) {
                const navItem = document.createElement('div');
                navItem.className = 'mini-nav-item';
                navItem.textContent = i + 1;
                navItem.onclick = () => loadQuestion(i);
                if (i === currentQuestionIndex) navItem.classList.add('current');
                miniNav.appendChild(navItem);
            }
        }

        function updateQuestionNavigation() {
            document.querySelectorAll('.mini-nav-item').forEach((item, index) => {
                item.classList.remove('current', 'answered', 'not-answered');
                if (index === currentQuestionIndex) item.classList.add('current');
                if (quizData.questions && quizData.questions[index]) {
                    const questionId = quizData.questions[index]._id;
                    if (answers[questionId] !== undefined && answers[questionId] !== '') {
                        item.classList.add('answered');
                    } else {
                        item.classList.add('not-answered');
                    }
                }
            });
        }

        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / quizData.totalQuestions) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressPercentage').textContent = Math.round(progress) + '%';
        }

        function updateQuizSummary() {
            const answered = Object.keys(answers).length;
            document.getElementById('summaryAnswered').textContent = answered;
            document.getElementById('summaryRemaining').textContent = quizData.totalQuestions - answered;
        }

        function checkSubmitButton() {
            document.getElementById('submitButton').disabled = Object.keys(answers).length < quizData.totalQuestions;
        }

        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    submitQuiz(true);
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('timerText').textContent = timeString;
            const summaryTimeLeft = document.getElementById('summaryTimeLeft');
            if (summaryTimeLeft) summaryTimeLeft.textContent = timeString;
            
            const timerElement = document.getElementById('quizTimer');
            if (timerElement) {
                timerElement.classList.remove('timer-warning', 'timer-danger');
                if (timeRemaining <= 60) {
                    timerElement.classList.add('timer-danger');
                } else if (timeRemaining <= 300) {
                    timerElement.classList.add('timer-warning');
                }
            }
        }

        function submitQuiz(isAutoSubmit = false) {
            if (!isAutoSubmit && Object.keys(answers).length < quizData.totalQuestions) {
                showToast(`Please answer all questions. You have answered ${Object.keys(answers).length} out of ${quizData.totalQuestions} questions.`, 'error');
                return;
            }
            
            if (timerInterval) clearInterval(timerInterval);
            document.getElementById('submitButton').disabled = true;
            
            fetch(`/guest/quiz/${quizData.quizId}/submit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    answers: answers,
                    timeSpent: quizData.settings.duration ? (quizData.settings.duration * 60 - timeRemaining) : 0,
                    completedAt: new Date().toISOString(),
                    attemptNumber: quizData.attemptNumber
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    clearSavedState();
                    showQuizResults(data.result || data.data || data, data.redirectUrl);
                } else {
                    showToast('Error submitting quiz: ' + data.message, 'error');
                    document.getElementById('submitButton').disabled = false;
                }
            })
            .catch(error => {
                showToast('Network error. Please try again.', 'error');
                document.getElementById('submitButton').disabled = false;
            });
        }

        function showQuizResults(result, redirectUrl) {
            // result contains: score, correctAnswers, totalQuestions, passed, showResults, etc.
            const passed = result.passed || false;
            const score = result.score || 0;
            const correctAnswers = result.correctAnswers || 0;
            const totalQuestions = result.totalQuestions || quizData.totalQuestions;
            const showResults = result.showResults !== false;
            
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000;';
            const modal = document.createElement('div');
            modal.style.cssText = 'background: white; border-radius: 16px; padding: 24px; max-width: 420px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.2);';
            
            let buttonsHtml = `
                <div style="display:flex; gap:8px; justify-content:flex-end;">
                    <button id="btnCloseTab" class="nav-button secondary" style="padding:10px 14px;"><i class="fas fa-times"></i> Close</button>
            `;
            
            if (showResults) {
                buttonsHtml += `<a href="${redirectUrl || '/guest/quiz/' + quizData.quizId + '/results'}" class="nav-button" style="padding:10px 14px; text-decoration:none;"><i class="fas fa-chart-line"></i> View Results</a>`;
            }
            
            buttonsHtml += `</div>`;
            
            modal.innerHTML = `
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                    <i class="fas fa-${passed ? 'check-circle' : 'info-circle'}" style="font-size:22px; color:${passed ? '#10b981' : '#3b82f6'}"></i>
                    <h3 style="margin:0; font-size:18px; color:#111827;">${passed ? 'Quiz Completed!' : 'Quiz Finished'}</h3>
                </div>
                <div style="margin-bottom:16px; color:#374151;">
                    <p style="margin:6px 0;">Score: <strong>${score}%</strong></p>
                    <p style="margin:6px 0;">Correct: <strong>${correctAnswers}/${totalQuestions}</strong></p>
                    <p style="margin:6px 0;">Status: <strong>${passed ? 'Passed' : 'Finished'}</strong></p>
                    ${!showResults ? '<p style="margin:6px 0; font-size:12px; color:#6b7280;"><i class="fas fa-info-circle"></i> Detailed results are not available for this quiz.</p>' : ''}
                </div>
                ${buttonsHtml}
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            modal.querySelector('#btnCloseTab').addEventListener('click', function() {
                try { window.close(); } catch (_) {}
                window.location.href = `/guest/quiz/${quizData.quizId}/details`;
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-header">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'info' ? 'info-circle' : 'exclamation-circle'} toast-icon"></i>
                    <span class="toast-title">${type === 'success' ? 'Success' : type === 'info' ? 'Info' : 'Error'}</span>
                </div>
                <div class="toast-message">${message}</div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        window.addEventListener('beforeunload', function(e) {
            if (quizStarted && Object.keys(answers).length > 0) {
                e.preventDefault();
                e.returnValue = 'You have unsaved answers. Are you sure you want to leave?';
            }
        });

        function previewImage(imageSrc) {
            const modal = document.getElementById('imagePreviewModal');
            document.getElementById('previewImage').src = imageSrc;
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeImagePreview() {
            document.getElementById('imagePreviewModal').classList.remove('show');
            document.body.style.overflow = '';
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') closeImagePreview();
        });

        function goBack() {
            saveState();
            window.location.href = '/guest/quiz/<%= quiz._id %>/details';
        }
    </script>
</body>
</html>
