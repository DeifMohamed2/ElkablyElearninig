<%- include('partials/header', { title: title }) %>

<!-- Import Payment Results CSS -->
<link rel="stylesheet" href="/css/payment-results.css">

<!-- Floating Math Elements -->
<div class="floating-math-elements-professor" id="floatingMath">
  <div class="math-element-professor" data-equation="∂">∂</div>
  <div class="math-element-professor" data-equation="∇">∇</div>
  <div class="math-element-professor" data-equation="∫">∫</div>
  <div class="math-element-professor" data-equation="∑">∑</div>
  <div class="math-element-professor" data-equation="∏">∏</div>
  <div class="math-element-professor" data-equation="∞">∞</div>
  <div class="math-element-professor" data-equation="∃">∃</div>
  <div class="math-element-professor" data-equation="∀">∀</div>
  <div class="math-element-professor" data-equation="ℝ">ℝ</div>
  <div class="math-element-professor" data-equation="ℂ">ℂ</div>
</div>

<!-- Payment Failure Page -->
<div class="payment-result-page payment-fail-page">
  <div class="container">
    <div class="payment-result-container">
      <!-- Failure Header -->
      <div class="payment-fail-header">
        <div class="fail-icon">
          <i class="fas fa-times-circle"></i>
        </div>
        <h1 class="fail-title">Payment Failed</h1>
        <p class="fail-message">
          <%= message || 'We encountered an issue processing your payment. Please try again or contact support.' %>
        </p>
      </div>

      <!-- Error Information -->
      <div class="error-info">
        <div class="error-card">
          <div class="card-header">
            <h3><i class="fas fa-exclamation-triangle"></i> What Happened?</h3>
          </div>
          <div class="card-body">
            <div class="error-reasons">
              <div class="reason-item">
                <div class="reason-icon">
                  <i class="fas fa-credit-card"></i>
                </div>
                <div class="reason-content">
                  <h4>Payment Issues</h4>
                  <p>Your card may have been declined, or there might be insufficient funds.</p>
                </div>
              </div>

              <div class="reason-item">
                <div class="reason-icon">
                  <i class="fas fa-wifi"></i>
                </div>
                <div class="reason-content">
                  <h4>Connection Problems</h4>
                  <p>A network issue may have interrupted the payment process.</p>
                </div>
              </div>

              <div class="reason-item">
                <div class="reason-icon">
                  <i class="fas fa-shield-alt"></i>
                </div>
                <div class="reason-content">
                  <h4>Security Checks</h4>
                  <p>Your bank's security system may have flagged the transaction.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Solutions -->
      <div class="solutions">
        <div class="solutions-card">
          <div class="card-header">
            <h3><i class="fas fa-lightbulb"></i> What Can You Do?</h3>
          </div>
          <div class="card-body">
            <div class="solution-steps">
              <div class="step-item">
                <div class="step-number">1</div>
                <div class="step-content">
                  <h4>Check Your Card Details</h4>
                  <p>Ensure your card number, expiry date, and CVV are correct.</p>
                </div>
              </div>

              <div class="step-item">
                <div class="step-number">2</div>
                <div class="step-content">
                  <h4>Verify Your Balance</h4>
                  <p>Make sure you have sufficient funds in your account.</p>
                </div>
              </div>

              <div class="step-item">
                <div class="step-number">3</div>
                <div class="step-content">
                  <h4>Try a Different Card</h4>
                  <p>Use an alternative payment method if available.</p>
                </div>
              </div>

              <div class="step-item">
                <div class="step-number">4</div>
                <div class="step-content">
                  <h4>Contact Your Bank</h4>
                  <p>Your bank may need to approve international transactions.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Support Information -->
      <div class="support-info">
        <div class="support-card">
          <div class="card-body">
            <div class="support-content">
              <div class="support-icon">
                <i class="fas fa-headset"></i>
              </div>
              <div class="support-text">
                <h3>Need Help?</h3>
                <p>Our support team is here to assist you with your payment issues.</p>
                <div class="contact-methods">
                  <div class="contact-item">
                    <i class="fas fa-envelope"></i>
                    <span>support@mrkably.com</span>
                  </div>
                  <div class="contact-item">
                    <i class="fas fa-phone"></i>
                    <span>+20 123 456 7890</span>
                  </div>
                  <div class="contact-item">
                    <i class="fas fa-clock"></i>
                    <span>24/7 Support Available</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <a href="/purchase/checkout" class="btn btn-primary btn-lg">
          <i class="fas fa-redo-alt"></i>
          Try Again
        </a>
        <a href="/" class="btn btn-outline btn-lg">
          <i class="fas fa-home"></i>
          Return Home
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  // Clear cart on payment failure page
  document.addEventListener('DOMContentLoaded', function() {
    // First clear server-side cart
    fetch('/purchase/cart/clear', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    }).then(response => response.json())
      .then(data => {
        console.log('Server-side cart cleared:', data);
        
        // Clear client-side cart state
        if (window.sessionCart) {
          window.sessionCart = [];
        }
        
        // Update cart using globalCart methods if available
        if (window.globalCart) {
          window.globalCart.setSessionCart([]);
          window.globalCart.updateCartCount();
          window.globalCart.updateCartSidebar();
          if (typeof window.globalCart.clearCart === 'function') {
            window.globalCart.clearCart();
          }
        }
        
        // Update cart count badge manually
        const cartCountElements = document.querySelectorAll('#cartCount, .cart-count, .cart-badge');
        cartCountElements.forEach(element => {
          element.textContent = '0';
          element.style.display = 'none';
        });
        
        // Close cart sidebar if open
        const cartSidebar = document.getElementById('cartSidebar');
        if (cartSidebar && cartSidebar.classList.contains('active')) {
          cartSidebar.classList.remove('active');
          document.body.style.overflow = '';
        }
        
        // Clear cart items from sidebar
        const cartItems = document.getElementById('cartItems');
        if (cartItems) {
          cartItems.innerHTML = `
            <div class="cart-empty">
              <div class="cart-empty-icon">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <h4>Your cart is empty</h4>
              <p>Add some courses to get started!</p>
            </div>
          `;
        }
        
        console.log('Cart fully cleared and UI updated on payment failure page');
      })
      .catch(error => {
        console.error('Error clearing cart:', error);
      });
  });
</script>

<%- include('partials/footer') %>